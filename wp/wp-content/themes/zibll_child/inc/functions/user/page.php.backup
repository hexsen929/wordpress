<?php
/*
 * @Author        : Qinver
 * @Url           : zibll.com
 * @Date          : 2021-10-09 22:46:56
 * @LastEditTime : 2025-07-25 15:20:20
 * @Email         : 770349780@qq.com
 * @Project       : Zibll子比主题
 * @Description   : 一款极其优雅的Wordpress主题|用户中心页面的相关函数
 * @Read me       : 感谢您使用子比主题，主题源码有详细的注释，支持二次开发。
 * @Remind        : 使用盗版主题会存在各种未知风险。支持正版，从我做起！
 */

//输出用户中心页面的头部
function zib_user_page_header()
{
    $user    = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;

    $info_class = 'flex header-info relative hh';
    $cover      = get_user_cover_img($user_id);
    $dropup_btn = '';
    $avatar     = zib_get_avatar_box($user_id, 'avatar-img', false, false);

    $avatar = '<div class="hover-show relative">';
    $avatar .= zib_get_avatar_box($user_id, 'avatar-img', false, false);
    $avatar .= zib_get_user_avatar_set_link('absolute hover-show-con flex jc xx', '<i class="fa fa-camera mb6" aria-hidden="true"></i>修改头像') ?: ($user_id ? zib_get_user_home_link($user_id, 'absolute', '') : '');
    $avatar .= '</div>';

    $desc = '';
    $btns = '';

    if ($user_id) {
        $dropup_btn = '<div class="abs-center right-bottom box-body cover-btns">' . zib_get_user_page_header_dropup_btn($user_id) . '</div>';
        $name       = '<span class="display-name">' . zibpay_get_vip_icon(zib_get_user_vip_level($user_id), 'mr3') . $user->display_name . zib_get_user_auth_badge($user_id, 'ml3') . zib_get_user_level_badge($user_id, 'ml3') . '</span>';

        if (_pz('checkin_s')) {
            $btns = zib_get_user_checkin_btn('but c-blue ml10 pw-1em radius', '<i class="fa fa-calendar-check-o"></i>签到', '<i class="fa fa-calendar-check-o"></i>已签到');
        } else {
            $btns = zib_get_user_home_link($user_id, 'but c-blue ml10 pw-1em radius', '<i class="fa fa-map-marker"></i>我的主页');
        }

        if (_pz('message_s')) {
            $btns .= zibmsg_nav_radius_button($user_id, 'ml10');
        }

        $btns = '<div class="header-btns flex0 flex ac">' . $btns . '</div>';

        $desc = '<span class="but" data-clipboard-tag="用户名" data-clipboard-text="' . $user->user_login . '"><i class="fa fa-user-o"></i>' . $user->user_login . '</span>';
        $desc .= $user->user_email ? '<span class="but" data-clipboard-tag="邮箱" data-clipboard-text="' . $user->user_email . '"><i class="fa fa-envelope-o"></i>' . $user->user_email . '</span>' : '';

        $desc = apply_filters('user_page_header_desc', $desc, $user_id);

        $info_html_flex1 = '<div class="flex1">';
        $info_html_flex1 .= '<div class="em12 name">' . $name . '</div>';
        $info_html_flex1 .= '<div class="desc user-identity flex ac hh">' . $desc . '</div>';
        $info_html_flex1 .= '</div>';
    } else {
        $info_class .= ' signin-loader';
        $info_html_flex1 = '<a href="javascript:;" class="display-name">Hi！请登录</a>';
    }

    $info_html = '<div class="' . $info_class . '">';
    $info_html .= '<div class="flex0 header-avatar">';
    $info_html .= $avatar;
    $info_html .= '</div>';
    $info_html .= $info_html_flex1;
    $info_html .= $btns;
    $info_html .= '</div>';

    $html = '<div class="author-header mb20 radius8 main-shadow main-bg full-widget-sm">';
    $html .= '<div class="page-cover">' . $cover . '<div class="absolute linear-mask"></div>' . $dropup_btn . '</div>';
    $html .= '<div class="header-content">';
    $html .= $info_html;
    $html .= '</div>';
    $html .= '</div>';
    echo $html;
}
add_action('user_center_page_content', 'zib_user_page_header', 8);

function zib_get_user_page_nav_title($a = '', $b = '')
{
    return '<span class="flex ac">' . $a . '</span><span class="em09 muted-2-color">' . $b . '<i class="ml6 fa fa-angle-right show-sm em12"></i></span>';
}

function zib_get_user_page_header_dropup_btn($user_id)
{

    $lists = '<li>' . zib_get_user_home_link($user_id, '', '<i class="fa fa-map-marker mr6"></i>我的主页') . '</li>';
    $lists .= '<li>' . zib_get_user_cover_set_link('', '<i class="fa fa-camera mr6" aria-hidden="true"></i>修改封面') . '</li>';

    return '<span class="dropup pull-right"><a href="javascript:;" class="item mr3 toggle-radius" data-toggle="dropdown">' . zib_get_svg('menu_2') . '</a><ul class="dropdown-menu">' . $lists . '</ul></span>';
}

//用户中心页面的主内容
function zib_user_page_content()
{

    $user    = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;

    $tabs_array = apply_filters('user_ctnter_main_tabs_array', array());

    foreach ($tabs_array as $k => $v) {
        $tabs_array[$k]['nav_attr'] .= ' data-drawer="show" route="' . zib_get_user_center_url($k) . '" route-back="' . zib_get_user_center_url() . '"';
    }

    $tab_nav = zib_get_main_tab_nav('nav', $tabs_array, 'user', false, 'user_center');

    if ($user_id) {
        $tab_content = zib_get_main_tab_nav('content', $tabs_array, 'user', false, 'user_center');
    } else {
        $tab_content = '<div class="zib-widget flex jc" style="min-height: 360px;">' . zib_get_user_singin_page_box() . '</div>';
    }

    if ($tab_nav && $tab_content) {
        echo '<div class="user-center row gutters-10">';
        echo '<div class="col-sm-3">';
        echo '<div class="sidebar-user">';
        dynamic_sidebar('user_sidebar_top');
        echo '</div>';

        echo apply_filters('user_center_page_sidebar', '');
        echo '<div class="sidebar-user">';
        dynamic_sidebar('user_sidebar_bottom');
        echo '</div>';

        echo '<div class="hide">';
        echo $tab_nav;
        echo '</div>';
        echo '</div>';
        echo '<div class="user-center-content col-sm-9 drawer-sm right">';
        echo $tab_content;
        echo '</div>';
        echo '</div>';
    }
}
add_action('user_center_page_content', 'zib_user_page_content');

/**
 * @description: 用户中心第一行的显示按钮
 * @param {*} $tabs_array
 * @return {*}
 */
function zib_user_ctnter_main_tabs_array_filter_main($tabs_array)
{

    if (_pz('user_level_s', true)) {
        $tabs_array['level'] = array(
            'title'    => '我的等级',
            'nav_attr' => 'drawer-title="我的等级"',
            'loader'   => '<div class="row gutters-10"><div class="col-sm-5"><div class="colorful-bg jb-vip1 zib-widget"><div class="colorful-make"></div><div class="relative flex xx jsb" style="height: 146px;"><div class="placeholder k1"></div><div class="placeholder t1"></div><div class="placeholder s1"></div></div></div></div><div class="col-sm-7"><div class="colorful-bg c-gray zib-widget"><div class="colorful-make"></div><div class="relative flex xx jsb" style="height: 146px;"><div class="placeholder k1"></div><div class="placeholder t1"></div><div class="placeholder s1"></div></div></div></div></div><div class="zib-widget"><div class="box-body"><p class="placeholder k1"></p><p class="placeholder k2"></p><p class="placeholder k1" style="height: 120px;"></p><p class="placeholder t1"></p><p class="placeholder k1"></p><p class="placeholder t1"></p><p class="placeholder k1"></p><p class="placeholder k1"></p><p class="placeholder k1"></p></div></div>',
        );
    }

    if (_pz('user_auth_s', true)) {
        $tabs_array['auth'] = array(
            'title'    => '官方认证',
            'nav_attr' => 'drawer-title="官方认证"',
            'loader'   => '<div style="padding: 40px 20px;" class="colorful-bg c-blue flex jc zib-widget"><div class="colorful-make"></div><div class="text-center"><div class="em4x"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-user-auth"></use></svg></div><div class="mt10 em14 padding-w10 font-bold mb40">官方认证</div><div class="placeholder" style="width: 120px;height: 30px;">  </div></div></div>',
        );
    }

    if (_pz('post_rewards_s') || _pz('pay_rebate_s')) {
        $tabs_array['rewards'] = array(
            'title'    => '打赏收款',
            'nav_attr' => 'drawer-title="打赏收款设置"',
            'loader'   => '<div class="zib-widget"><div class="mt10"><div class="placeholder k1 mb10"></div><div class="placeholder k1 mb10"></div><div class="placeholder s1"></div></div><p class="placeholder k1 mb30"></p><div class="placeholder t1 mb30"></div><p class="placeholder k1 mb30"></p><p style="height: 120px;" class="placeholder t1"></p></div>',
        );
    }

    $tabs_array['data'] = array(
        'title'         => '个人资料',
        'nav_attr'      => 'drawer-title="个人资料设置"',
        'content_class' => 'userdata-set',
        'loader'        => '<div class="zib-widget"><div class="mb30"><div class="author-set-left"><span class="avatar-img avatar-lg"><div class="placeholder avatar"></div></span></div><div class="author-set-right mt6"><div class="placeholder k1 mb10"></div><div class="placeholder k1 mb10"></div><div class="placeholder s1"></div></div></div><p class="placeholder k1 mb30"></p><div class="placeholder t1 mb30"></div><p class="placeholder k1 mb30"></p><p style="height: 120px;" class="placeholder t1"></p></div>',
    );

    $tabs_array['account'] = array(
        'title'         => '账户绑定及安全',
        'nav_attr'      => 'drawer-title="账户绑定及安全"',
        'content_class' => 'author-user-con',
        'loader'        => '<div class="zib-widget"><div class="mt10"><div class="placeholder k1 mb10"></div><div class="placeholder k1 mb10"></div><div class="placeholder s1"></div></div><p class="placeholder k1 mb30"></p><div class="placeholder t1 mb30"></div><p class="placeholder k1 mb30"></p><p style="height: 120px;" class="placeholder t1"></p></div>',
    );

    if (!current_user_can('manage_options')) {
        $tabs_array['complaint'] = array(
            'title'         => '我的投诉',
            'nav_attr'      => 'drawer-title="我的投诉进度"',
            'content_class' => 'author-user-con',
            'loader'   => '<div class="zib-widget"><div class="box-body notop nopw-sm"><div class="border-bottom box-body"><div style="width: 150px;" class="placeholder t1 mb10"></div><div class="placeholder t1"></div></div><div class="border-bottom box-body"><div style="width: 150px;" class="placeholder t1 mb10"></div><div class="placeholder t1"></div></div><div class="border-bottom box-body"><div style="width: 150px;" class="placeholder t1 mb10"></div><div class="placeholder t1"></div></div><div class="box-body nobottom"><div style="width: 150px;" class="placeholder t1"></div></div></div></div>',
        );
    }

    return $tabs_array;
}
add_filter('user_ctnter_main_tabs_array', 'zib_user_ctnter_main_tabs_array_filter_main');

function load_custom_js_on_user_center_page()
{
    if (get_query_var('user_center')) {
        wp_enqueue_script('mrhe_user_center', get_stylesheet_directory() . '/mrhecode/js/pay-api.js', array('jquery'), THEME_VERSION);
    }
}
add_action('wp_enqueue_scripts', 'load_custom_js_on_user_center_page');

function check_order_and_user($order_num)
{
    $user = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;

    if (!$user_id) {
        return;
    }

    // 直接通过 order_num 从数据库查询订单和授权信息
    global $wpdb;
    
    // 1. 从订单表获取订单信息
    $order = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM {$wpdb->zibpay_order} 
         WHERE order_num = %s AND user_id = %d AND status = 1",
        $order_num,
        $user_id
    ), ARRAY_A);
    
    if (!$order) {
        display_error_message('未找到订单信息');
        wp_die();
    }
    
    // 2. 从授权表获取授权信息
    $table_name = $wpdb->prefix . 'mrhe_theme_aut';
    $auth_record = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $table_name 
         WHERE user_id = %d AND post_id = %d",
        $user_id,
        $order['post_id']
    ), ARRAY_A);
    
    if (!$auth_record) {
        display_error_message('未找到授权信息');
        wp_die();
    }
    
    // 3. 合并订单信息和授权信息
    return array_merge($order, array(
        'status' => 1,
        'auth_code' => $auth_record['auth_code'],
        'domain' => $auth_record['domain'],
        'aut_max_url' => $auth_record['aut_max_url'],
        'is_authorized' => $auth_record['is_authorized'],
        'product_id' => $auth_record['product_id']
    ));
}

function mrhe_get_add_domain_aut_link($class = '', $text = '添加/更换授权域名', $action = '', $mrhe_order_num = '')
{

    $user_id = get_current_user_id();
    if (!$user_id) {
        return;
    }

    $args = array(
        'tag'           => 'a',
        'class'         => 'but mm3 padding-lg ' . $class,
        'mobile_bottom' => true,
        'height'        => 400,
        'text'          => $text,
        'query_arg'     => array(
            'action' => $action,
            'mrhe_order_num' => $mrhe_order_num
        ),
    );

    return zib_get_refresh_modal_link($args);
}

function mrhe_get_replace_domain_aut_link($class = '', $text = '更换授权域名', $action = '', $mrhe_order_num = '')
{
    $user_id = get_current_user_id();
    if (!$user_id) {
        return;
    }

    $args = array(
        'tag'           => 'a',
        'class'         => 'but mm3 padding-lg ' . $class,
        'mobile_bottom' => true,
        'height'        => 400,
        'text'          => $text,
        'query_arg'     => array(
            'action' => $action,
            'mrhe_order_num' => $mrhe_order_num
        ),
    );

    return zib_get_refresh_modal_link($args);
}
function mrhe_aut_add_modal()
{
    $order_num = $_GET['mrhe_order_num'];
    $user_id = get_current_user_id();
    
    $purchase_result = check_order_and_user($order_num);
    $max_domains = $purchase_result['aut_max_url'];
    
    // 处理域名数据 - 使用WordPress标准方法
    $existing_domains = maybe_unserialize($purchase_result['domain']);
    if (!is_array($existing_domains)) {
        $existing_domains = array();
    }
    $domain_count = mrhe_count_used_domains($existing_domains);
?>
    <div class="mb10 touch">
        <div class="mr10 inflex em12"><svg class="em14 mr10" aria-hidden="true">
                <use xlink:href="#icon-vip_2"></use>
            </svg><b>添加授权</b></div><button class="close" data-dismiss="modal"><svg class="ic-close" aria-hidden="true">
                <use xlink:href="#icon-close"></use>
            </svg></button>
    </div>
    <div class="padding-10">
        <p class="muted-2-color">添加授权域名前，请先阅读详细<a class="focus-color" target="_blank" href="https://www.zibll.com/zibll-pay-desc">授权规范</a></p>
        <ul class="muted-2-color theme-box">
            <li class="c-red" style="--this-color: #f737a3;"><i class="fa fa-info-circle mr6"></i>授权仅限本人使用，添加非本人名下域名将做封号处理</li>
            <li class="c-red"><i class="fa fa-info-circle mr6"></i>添加后的域名不能删除，但支持不限次数免费更换</li>
            <li class="c-red" style="--this-color: #ff6643;"><i class="fa fa-info-circle mr6"></i>如考虑到可能会更换域名请注意在域名过期前提前更换</li>
        </ul>
        <div class="muted-color">域名示例:</div>
        <ul class="muted-2-color theme-box">
            <li>授权顶级域名：hexsen.com</li>
            <li>授权二级域名：blog.hexsen.com</li>
            <li>如果是中文域名，请输入转码后的域名</li>
            <li>如果有任何疑问，请与客服联系</li>
        </ul>
        <form class="pay-form">
            <?php
            $remaining_domains = $max_domains - $domain_count;

            for ($i = 0; $i < $remaining_domains; $i++) {
                echo '<div class="author-set-left">域名 ' . ($i + 1) . '</div>';
                echo '<div class="author-set-right theme-box">';
                echo '<input type="input" class="form-control" name="domains[]" value="" placeholder="请输入域名">';
                echo '</div>';
            }
            ?>
            <div class="box-body text-center nobottom">
                <a href="javascript:;" class="but jb-blue radius btn-block padding-lg addzibaut" style="max-width:260px;">提交</a>
            </div>
            <input type="hidden" name="user_id" value="<?php echo $user_id; ?>">
            <input type="hidden" name="action" value="mrhe_user_add_aut">
            <input type="hidden" name="post_id" value="<?php echo $purchase_result['post_id']; ?>">
            <input type="hidden" name="product_id" value="<?php echo !empty($purchase_result['product_id']) ? esc_attr($purchase_result['product_id']) : 'post_' . $purchase_result['post_id']; ?>">
            <input type="hidden" name="order_num" value="<?php echo $order_num; ?>">
            <input type="hidden" name="_wpnonce" value="<?php echo wp_create_nonce('mrhe_user_add_aut'); ?>">
        </form>
    </div>
<?php
    exit();
}
add_action('wp_ajax_mrhe_aut_add_modal', 'mrhe_aut_add_modal');

function mrhe_aut_replace_modal()
{
    $order_num = $_GET['mrhe_order_num'];
    $user_id = get_current_user_id();
    
    $purchase_result = check_order_and_user($order_num);
    
    // 处理域名数据 - 使用WordPress标准方法
    $existing_domains = maybe_unserialize($purchase_result['domain']);
    if (!is_array($existing_domains)) {
        $existing_domains = array();
    }
    
    $domain_count = mrhe_count_used_domains($existing_domains);
?>
    <div class="mb10 touch">
        <div class="mr10 inflex em12">
            <svg class="em14 mr10" aria-hidden="true">
                <use xlink:href="#icon-vip_2"></use>
            </svg>
            <b>更换授权</b>
        </div>
        <button class="close" data-dismiss="modal">
            <svg class="ic-close" aria-hidden="true">
                <use xlink:href="#icon-close"></use>
            </svg>
        </button>
    </div>
    <div class="padding-10">
        <div class="muted-color">更换要求及说明:</div>
        <ul class="muted-2-color theme-box">
            <li class="c-red" style="--this-color: #f737a3;">
                <i class="fa fa-info-circle mr6"></i>授权域名名额添加完之后才能更换域名
            </li>
            <li class="c-red">
                <i class="fa fa-info-circle mr6"></i>更换前域名和新域名所有人为同一人
            </li>
            <li class="c-red" style="--this-color: #ff6643;">
                <i class="fa fa-info-circle mr6"></i>或者更换前域名和新域名备案人为同一人
            </li>
            <li class="mb10 em09">
                如果系统自动审核失败，请准备相关截图及待更换的域名与微信客服联系
            </li>
            <li class="">
                <div class="text-center hide-sm" style="width: 120px;">
                    <img src="https://cravatar.cn/avatar/fbacea24f9dbfd4a258604cf4e69bf49">
                    <div class="px12">扫码联系微信客服</div>
                </div>
                <a target="_blank" href="https://work.weixin.qq.com/kfid/kfca772106896c80838" class="but c-blue show-sm">
                    <i class="fa fa-wechat"></i>点击联系微信客服
                </a>
            </li>
        </ul>
        <?php if ($domain_count > 0) { ?>
            <form>
                <div class="mb20">
                    <div class="mb6">选择需更换域名</div>
                    <div class="muted-color">
                        <?php
                        // 使用 mrhe_get_display_domains() 过滤掉 www 域名
                        $display_domains = mrhe_get_display_domains($existing_domains);
                        
                        if (empty($display_domains)) {
                            echo '<div class="c-red">没有可更换的域名</div>';
                        } else {
                            foreach ($display_domains as $domain) {
                                $domain_value = is_array($domain) ? $domain['domain'] : $domain;
                                echo '<label class="badg p2-10 mr10 pointer">';
                                echo '<input type="radio" name="aut_url" value="' . esc_attr($domain_value) . '"> ' . esc_html($domain_value);
                                echo '</label>';
                            }
                        }
                        ?>
                    </div>
                </div>
                <div class="mb10">
                    <div class="mb10">输入新域名</div>
                    <div class="">
                        <input class="form-control" name="new_aut_url" type="text" placeholder="请输入新域名">
                    </div>
                </div>
                <div class="box-body text-center nobottom">
                    <button class="but jb-blue radius btn-block padding-lg wp-ajax-submit">
                        <i class="fa fa-check" aria-hidden="true"></i>确认提交
                    </button>
                </div>
                <input type="hidden" name="action" value="mrhe_user_replace_aut">
                <input type="hidden" name="_wpnonce" value="<?php echo wp_create_nonce('mrhe_user_replace_aut'); ?>" />
                <input type="hidden" name="user_id" value="<?php echo $user_id; ?>">
                <input type="hidden" name="post_id" value="<?php echo $purchase_result['post_id']; ?>">
                <input type="hidden" name="product_id" value="<?php echo !empty($purchase_result['product_id']) ? esc_attr($purchase_result['product_id']) : 'post_' . $purchase_result['post_id']; ?>">
                <input type="hidden" name="order_num" value="<?php echo $order_num; ?>">
            </form>
        <?php } else { ?>
            <div class="mb20">
                <div class="c-red mb10"><i class="fa fa-info-circle mr6"></i> 抱歉，您当前没有已授权的域名，请先添加域名</div>
                <div class="box-body text-center nobottom"><?php echo mrhe_get_add_domain_aut_link('jb-blue', '添加授权域名', 'mrhe_aut_add_modal', $order_num) ?></div>
            </div>
        <?php } ?>
    </div>
<?php
    exit();
}
add_action('wp_ajax_mrhe_aut_replace_modal', 'mrhe_aut_replace_modal');

function zib_main_user_tab_content_autproduct()
{
    $form = '111';
    $html = '' . $form . '';
    return zib_get_ajax_ajaxpager_one_centent($html);
}
add_filter('main_user_tab_content_autproduct', 'zib_main_user_tab_content_autproduct');

/**
 * 获取页面设置中的下载资源
 * 
 * 配置方式：
 * 1. 进入产品页面编辑器
 * 2. 找到"产品购买设置"部分
 * 3. 在"资源下载"中添加下载资源
 * 4. 设置下载地址、按钮文案、图标、颜色等
 * 
 * 支持的字段：
 * - link: 下载地址（必填）
 * - name: 按钮文案
 * - icon: 按钮图标（默认：fa fa-download）
 * - class: 按钮颜色样式（默认：b-theme）
 * - more: 资源备注（如密码）
 * - copy_key: 复制按钮名称
 * - copy_val: 复制内容
 */
function mrhe_get_download_resources($post_id) {
    if (empty($post_id)) {
        return array();
    }
    
    $pay_mate = get_post_meta($post_id, 'posts_zibpay', true);
    if (empty($pay_mate) || !is_array($pay_mate)) {
        return array();
    }
    
    $download_resources = $pay_mate['pay_download'] ?? array();
    if (empty($download_resources) || !is_array($download_resources)) {
        return array();
    }
    
    
    // 过滤掉没有下载地址的资源，并验证数据完整性
    $valid_resources = array();
    foreach ($download_resources as $resource) {
        if (!empty($resource['link']) && is_array($resource)) {
            // 确保必要字段存在
            $valid_resource = array(
                'link' => sanitize_url($resource['link']),
                'name' => sanitize_text_field($resource['name'] ?? '资源下载'),
                'icon' => sanitize_text_field($resource['icon'] ?? 'fa fa-download'),
                'class' => sanitize_text_field($resource['class'] ?? 'b-theme'),
                'more' => sanitize_text_field($resource['more'] ?? ''),
                'copy_key' => sanitize_text_field($resource['copy_key'] ?? ''),
                'copy_val' => sanitize_text_field($resource['copy_val'] ?? ''),
            );
            
            $valid_resources[] = $valid_resource;
        }
    }
    
    return $valid_resources;
}

// 使用旧版本的侧边栏卡片方式添加产品授权管理页面
function mrhe_user_center_page_sidebar_custom_html($con)
{
    $user_id = get_current_user_id();
    $class = ''; // 初始化$class变量
    if (!$user_id) {
        $class = ' signin-loader';
    }
    $tabs_array = apply_filters('user_ctnter_main_tabs_array', array());
    $title = $tabs_array['product']['title'] ?? '产品授权';
    $custom_html = '
        <div class="colorful-bg jb-cyan zib-widget mb10-sm' . $class . '">
            <div class="colorful-make" style="transform: rotate(-28deg) scale(.8);"></div>
            <div class="flex ab c jsb">
                            <div class="">
                    <div class="flex ac">
                        <b class="em14">mrhe主题</b>
                            </div>
                    <div style="" class="em09 opacity8">更优雅的wordpress主题</div>
                    <a href="javascript:;" data-onclick="[data-target=\'#user-tab-product\']" class="mt6 but radius  jb-cyan px12 p2-10">' . $title . '<i style="margin:0 0 0 6px;" class="fa fa-angle-right em12"></i></a>
                    <a href="javascript:;" data-onclick="[data-target=\'#user-tab-autproduct\']" class="mt6 but radius  jb-yellow px12 p2-10">操作授权<i style="margin:0 0 0 6px;" class="fa fa-angle-right em12"></i></a>
                        </div>
                <span class="avatar-img mr10 mt3" style="--this-size: 59px;">
                    <img alt="mrhe主题" src="//cravatar.cn/avatar/fbacea24f9dbfd4a258604cf4e69bf49" class="avatar">
                </span>
            </div>
        </div>';

    $con .= $custom_html;
    return $con;
}
add_filter('user_center_page_sidebar', 'mrhe_user_center_page_sidebar_custom_html');

// 添加标签页定义
function mrhe_user_ctnter_main_tabs_array_filter_product($tabs_array)
{
    $tabs_array['product'] = array(
        'title'         => '授权管理',
        'nav_attr'      => 'drawer-title="产品授权"',
        'content_class' => 'author-user-con',
        'loader'   => '<div class="zib-widget"><i class="placeholder s1"></i><p class="placeholder t1"></p><p style="height: 110px;" class="placeholder k1"></p><p class="placeholder k2"></p><p style="height: 110px;" class="placeholder k1"></p><p class="placeholder t1"></p><i class="placeholder s1"></i><i class="placeholder s1 ml10"></i></div>',
    );

    if (current_user_can('manage_options')) {
        $tabs_array['autproduct'] = array(
            'title'         => '操作授权',
            'nav_attr'      => 'drawer-title="操作授权"',
            'content_class' => 'author-user-con',
            'loader'   => '<div class="zib-widget"><i class="placeholder s1"></i><p class="placeholder t1"></p><p style="height: 110px;" class="placeholder k1"></p><p class="placeholder k2"></p><p style="height: 110px;" class="placeholder k1"></p><p class="placeholder t1"></p><i class="placeholder s1"></i><i class="placeholder s1 ml10"></i></div>',
        );
    }

    return $tabs_array;
}
add_filter('user_ctnter_main_tabs_array', 'mrhe_user_ctnter_main_tabs_array_filter_product', 20);

// 产品授权页面内容 - 使用父主题风格
/**
 * @description: 用户中心-产品授权页面内容
 * @param {*}
 * @return {*}
 */
function zib_main_user_tab_content_product()
{
    $user    = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;

    if (!$user_id) {
        return zib_get_ajax_ajaxpager_one_centent('<div class="zib-widget"><div class="text-center"><p class="muted-2-color">请先登录</p></div></div>');
    }

    // 添加缓存机制，避免重复查询
    $cache_key = 'mrhe_user_auth_content_' . $user_id;
    $cached_content = wp_cache_get($cache_key, 'mrhe_auth');
    
    if ($cached_content !== false) {
        return $cached_content;
    }

    // 获取用户的所有授权产品（只返回启用授权的产品）
    $auth_orders = mrhe_get_user_theme_orders($user_id, true);

    if (empty($auth_orders)) {
        $no_orders_html = '<div class="zib-widget">';
        $no_orders_html .= '<div class="text-center" style="padding:30px 0;">';
        $no_orders_html .= '<img style="width:280px;opacity: .7;" src="' . ZIB_TEMPLATE_DIRECTORY_URI . '/img/null-order.svg">';
        $no_orders_html .= '<p style="margin-top:30px;" class="em09 muted-3-color separator">暂无授权订单</p>';
        $no_orders_html .= '</div>';
        $no_orders_html .= '<div class="mb20 mt30 text-center">';
        $no_orders_html .= '<a class="but c-blue padding-lg" href="' . home_url('/pay-mrhe') . '">';
        $no_orders_html .= '<i class="fa fa-cart-plus fa-fw" aria-hidden="true"></i> 购买主题授权</a>';
        $no_orders_html .= '</div>';
        $no_orders_html .= '</div>';
        
        // 导入订单卡片
        $no_orders_html .= '<div class="theme-box user-pay">';
        $no_orders_html .= '<div class="zib-widget pay-box">';
        $no_orders_html .= '<div class="box-body theme-box">';
        $no_orders_html .= '<div class="c-red mb10"><i class="fa fa-angle-double-right em12 mr10"></i><b>导入订单</b></div>';
        $no_orders_html .= '<div class="muted-2-color em09">如果您是通过转账等其它方式购买的mrhe主题，请在下方输入您的授权码以导入订单及授权信息</div>';
        $no_orders_html .= '</div>';
        $no_orders_html .= '<form>';
        $no_orders_html .= '<div class="line-form theme-box">';
        $no_orders_html .= '<input type="text" name="aut_code" class="line-form-input text-center" tabindex="2" placeholder="请输入授权码">';
        $no_orders_html .= '<i class="line-form-line"></i>';
        $no_orders_html .= '</div>';
        $no_orders_html .= '<div class="box-body text-center">';
        $no_orders_html .= '<a href="javascript:;" class="but jb-blue radius btn-block padding-lg query-ordery" style="max-width:260px;">提交</a>';
        $no_orders_html .= '</div>';
        $no_orders_html .= '<input type="hidden" name="action" value="mrhe_query_autordery">';
        $no_orders_html .= '</form>';
        $no_orders_html .= '</div>';
        $no_orders_html .= '</div>';
        
        $result = zib_get_ajax_ajaxpager_one_centent($no_orders_html);
        wp_cache_set($cache_key, $result, 'mrhe_auth', 300); // 缓存5分钟
        return $result;
    }

    // 获取选中的产品（从URL参数或默认第一个）
    $selected_post_id = isset($_GET['product_id']) ? intval($_GET['product_id']) : 0;
    
    // 如果没有选中或选中的产品不存在，默认第一个
    if (!$selected_post_id || !in_array($selected_post_id, array_column($auth_orders, 'post_id'))) {
        $selected_post_id = $auth_orders[0]['post_id'];
    }
    
    // 修改缓存键，包含 product_id
    $cache_key = 'mrhe_user_auth_content_' . $user_id . '_' . $selected_post_id;
    $cached_content = wp_cache_get($cache_key, 'mrhe_auth');
    
    if ($cached_content !== false) {
        return $cached_content;
    }
    
    // 只获取选中产品的订单
    $selected_order = null;
    foreach ($auth_orders as $order) {
        if ($order['post_id'] == $selected_post_id) {
            $selected_order = $order;
            break;
        }
    }
    
    // 如果没找到选中的订单，使用第一个
    if (!$selected_order) {
        $selected_order = $auth_orders[0];
        $selected_post_id = $selected_order['post_id'];
    }

    // 批量获取所有授权信息，避免循环中重复查询数据库
    $all_auth_info = mrhe_get_user_all_auth_info($user_id);
    
    // 批量获取所有产品信息，避免循环中重复查询数据库
    $post_ids = array_column($auth_orders, 'post_id');
    $post_info = array();
    
    if (!empty($post_ids)) {
        global $wpdb;
        $posts = $wpdb->get_results(
            "SELECT ID, post_title, post_name FROM {$wpdb->posts} WHERE ID IN (" . implode(',', array_map('intval', $post_ids)) . ")",
            ARRAY_A
        );
        
        foreach ($posts as $post) {
            $post_info[$post['ID']] = array(
                'title' => $post['post_title'],
                'permalink' => get_permalink($post['ID']),
                'slug' => $post['post_name']
            );
        }
    }
    
    // 生成产品下拉框（多个产品时才显示）
    $html = '';
    if (count($auth_orders) > 1) {
        $html .= '<div class="zib-widget mb20">';
        $html .= '<div class="box-body">';
        $html .= '<div class="flex ac jsb">';
        $html .= '<label class="muted-2-color mr10"><i class="fa fa-cube mr6"></i>选择产品：</label>';
        $html .= '<select id="mrhe-product-selector" class="form-control" style="width: auto; max-width: 300px;">';
        
        foreach ($auth_orders as $order) {
            $selected = ($order['post_id'] == $selected_post_id) ? ' selected' : '';
            $html .= '<option value="' . $order['post_id'] . '"' . $selected . '>' . get_the_title($order['post_id']) . '</option>';
        }
        
        $html .= '</select>';
        $html .= '</div>';
        $html .= '</div>';
        $html .= '</div>';
    }
    
    // 只显示选中产品的授权信息
    $order = $selected_order;
    $post_id = $order['post_id'];
    
    // 动态获取 product_id：优先从订单表，后备从产品元数据
    $product_id = mrhe_get_dynamic_product_id($post_id, $user_id);
    
    // 只使用 post_id 作为键查询授权信息
    $auth_info = $all_auth_info[$post_id] ?? array(
            'post_id' => $post_id,
            'product_id' => $product_id,
            'auth_code' => '',
            'domains' => array(),
            'max_domains' => 3,
            'is_authorized' => 0
        );
        
        $post_data = $post_info[$post_id] ?? array(
            'title' => '未知产品',
            'permalink' => '#',
            'slug' => ''
        );
        
        $is_authorized = $auth_info['is_authorized'] ?? 0;
        $auth_code = $auth_info['auth_code'] ?? '';
        $domains = $auth_info['domains'] ?? array();
        $domain_count = mrhe_count_used_domains($domains);
        $max_domains = $auth_info['max_domains'] ?? 3;
        
        // 订单信息卡片 - 使用预获取的数据，避免数据库查询
        $order_html = sprintf(
            '<div class="zib-widget pay-box">
            <div class="pay-tag abs-center" style="left: auto;right: 0;border-radius: 0 var(--main-radius) 0 var(--main-radius);">订单信息</div>
            <div>
                    <div class="mb6"><b><a target="_blank" href="%s">%s</a></b></div>
                    <div class="meta-time em09 muted-2-color" title="点击复制订单号" data-clipboard-text="%s" data-clipboard-tag="订单号">订单号：<i class="fa fa-files-o mr3"></i>%s</div>
                    <dd class="meta-time em09 muted-2-color">付款时间：%s<span class="pull-right em12"><span class="pay-mark">价格：￥</span>%s<span class="pay-mark ml10">实付金额：</span><span class="pay-mark">￥</span>%s</span></dd>
            </div>
            </div>',
            esc_url($post_data['permalink']),
            esc_html($post_data['title']),
            esc_attr($order['order_num']),
            esc_html($order['order_num']),
            esc_html($order['pay_time']),
            esc_html($order['pay_price']),
            esc_html($order['pay_price'])
        );
        $html .= $order_html;
        
        // 授权信息卡片
        $html .= '<div class="zib-widget pay-box">';
        $html .= '<div class="pay-tag abs-center" style="left: auto;right: 0;border-radius: 0 var(--main-radius) 0 var(--main-radius);">授权信息</div>';
        $html .= '<div>';
        $html .= '<div class="box-body theme-box">';
        $html .= '<div class="c-red mb10"><i class="fa fa-diamond em12 mr10"></i><b>正版授权</b></div>';
        $html .= '<div class="muted-2-color em09">您当前可授权<span class="badg c-red badg-sm">' . $max_domains . '</span>个域名，已授权<span class="badg badg-sm c-red">' . $domain_count . '</span>个域名，如需更多域名授权，请与客服联系</div>';
        $html .= '</div>';
        $html .= '<form class="abs-right" style="top: 10px;right: 77px;">';
        $html .= '<a href="javascript:;" style="padding: 5px 10px 2px;border-radius: 0 0 8px 8px;--this-bg: rgba(77, 130, 249, .1);" class="but c-blue-2 em09 refresh-autordery" data-toggle="tooltip" title="" data-original-title="刷新授权数据"><i class="fa fa-refresh" aria-hidden="true"></i>刷新授权</a>';
        $html .= '<input type="hidden" name="action" value="mrhe_user_refresh_aut">';
        $html .= '<input type="hidden" name="aut_code" value="' . $auth_code . '">';
        $html .= '<input type="hidden" name="order_num" value="' . $order['order_num'] . '">';
        $html .= '<input type="hidden" name="post_id" value="' . $order['post_id'] . '">';
        $html .= '<input type="hidden" name="product_id" value="' . (!empty($order['product_id']) ? esc_attr($order['product_id']) : 'post_' . $order['post_id']) . '">';
        $html .= '<input type="hidden" name="_wpnonce" value="' . wp_create_nonce('mrhe_user_refresh_aut') . '">';
        $html .= '</form>';
        
        // 获取封禁状态
        $is_banned = $auth_info['is_banned'] ?? 0;
        
        if ($is_authorized) {
            if ($is_banned) {
                // 被封禁：只显示封禁提示，不显示任何授权详细信息
                $html .= '<div class="text-center mt10 mb10">';
                $html .= '<div class="c-red mb10">';
                $html .= '<i class="fa fa-ban mr6"></i><b>您的授权异常 请联系管理员</b>';
                $html .= '</div>';
                $html .= '<p class="muted-2-color em09">请联系管理员了解详情</p>';
                $html .= '</div>';
            } else {
                // 正常状态：显示所有授权详细信息
                // 授权码
                $html .= '<div class="mb10">';
                $html .= '<div class="author-set-left">授权码</div>';
                $html .= '<div class="author-set-right">';
                $html .= '<b data-toggle="tooltip" title="" data-clipboard-tag="授权码" data-clipboard-text="' . $auth_code . '" class="but c-red clip-aut mr10 mb6" data-original-title="点击复制">' . substr($auth_code, 0, 8) . '**********' . substr($auth_code, -10) . '</b>';
                $html .= '<a text="' . $auth_code . '" slash-text="' . substr($auth_code, 0, 8) . '**********' . substr($auth_code, -10) . '" class="eye-aut pointer opacity8 mr10"><i class="fa fa-eye"></i></a>';
                $html .= '<a data-clipboard-tag="授权码" data-clipboard-text="' . $auth_code . '" class="clip-aut pointer opacity8" data-toggle="tooltip" title="" data-original-title="复制授权码"><i class="fa fa-files-o"></i></a>';
                $html .= '</div>';
                $html .= '</div>';

                // 授权有效期
                $html .= '<div class="mb10">';
                $html .= '<div class="author-set-left">授权有效期</div>';
                $html .= '<div class="author-set-right"><span class="badg">永久</span></div>';
                $html .= '</div>';

                // 验证类型
                $html .= '<div class="mb10">';
                $html .= '<div class="author-set-left">验证类型</div>';
                $html .= '<div class="author-set-right"><span class="badg">授权码+域名验证</span></div>';
                $html .= '</div>';

                // 授权域名
                $html .= '<div class="mb10">';
                $html .= '<div class="author-set-left">授权域名</div>';
                $html .= '<div class="author-set-right">';
                if (!empty($domains)) {
                    // 只显示用户实际输入的域名，隐藏赠送的 www 子域名
                    $display_domains = mrhe_get_display_domains($domains);
                    foreach ($display_domains as $domain) {
                        $html .= '<span class="badg mr6 mb6 c-blue">' . $domain . '</span>';
                    }
                }
                $html .= '</div>';
                $html .= '</div>';

                // 根据domain_count显示不同的按钮
                $html .= '<div class="text-center mt10 mb10">';
                if ($domain_count < $max_domains) {
                    // 未达到最大域名数，只显示"添加授权域名"
                    $html .= '<a mobile-bottom="true" data-height="400" data-remote="' . admin_url('admin-ajax.php?action=mrhe_aut_add_modal&mrhe_order_num=' . $order['order_num']) . '" class="but mm3 padding-lg jb-blue" href="javascript:;" data-toggle="RefreshModal">添加授权域名</a>';
                } else {
                    // 域名已满，只显示"更换授权域名"
                    $html .= '<a mobile-bottom="true" data-height="400" data-remote="' . admin_url('admin-ajax.php?action=mrhe_aut_replace_modal&mrhe_order_num=' . $order['order_num']) . '" class="but mm3 padding-lg jb-yellow" href="javascript:;" data-toggle="RefreshModal">更换授权域名</a>';
                }
                $html .= '</div>';
            }
        }

        $html .= '</div>';
        $html .= '</div>';

        // 资源下载卡片
        $html .= '<div class="zib-widget pay-box">';
        $html .= '<div class="pay-tag abs-center" style="left: auto; right: 0; border-radius: 0 var(--main-radius) 0 var(--main-radius);">资源下载</div>';
        $html .= '<div class="theme-box">';
        $html .= '<div>';
        $html .= '<div class="flex ac hh">';
        
        // 获取页面设置中的下载资源
        $download_resources = mrhe_get_download_resources($order['post_id']);
        
        if (!empty($download_resources)) {
            // 每个下载按钮独立包裹（仿照 Zibll 官方风格）
            foreach ($download_resources as $resource) {
                $download_url = $resource['link'] ?? '#';
                $download_name = $resource['name'] ?? '资源下载';
                $download_icon = $resource['icon'] ?? 'fa fa-download';
                $download_class = $resource['class'] ?? 'b-theme';
                $download_more = $resource['more'] ?? '';
                $copy_key = $resource['copy_key'] ?? '';
                $copy_val = $resource['copy_val'] ?? '';
                
                // 每个按钮独立包裹在 but-download 中
                $html .= '<div class="but-download flex ac">';
                $html .= '<a target="_blank" href="' . esc_url($download_url) . '" class="mr10 but ' . esc_attr($download_class) . '">';
                $html .= '<i class="' . esc_attr($download_icon) . '" aria-hidden="true"></i>' . esc_html($download_name);
                $html .= '</a>';
                
                if (!empty($download_more)) {
                    if (!empty($copy_key) && !empty($copy_val)) {
                        // 显示资源备注（不可复制）和点击复制名称（可复制）
                        $html .= '<span class="badg">' . esc_html($download_more) . '</span>';
                        $html .= '<span class="badg c-blue" data-clipboard-tag="' . esc_attr($copy_key) . '" data-clipboard-text="' . esc_attr($copy_val) . '" style="cursor: pointer;">' . esc_html($copy_key) . '</span>';
                    } else {
                        $html .= '<span class="badg">' . esc_html($download_more) . '</span>';
                    }
                }
                
                $html .= '</div>'; // 关闭 but-download
            }
        } else {
            // 如果没有配置下载资源，显示默认的下载选项
            $html .= '<div class="but-download flex ac">';
            $html .= '<a target="_blank" href="#" class="mr10 but c-blue"><i class="fa fa-download" aria-hidden="true"></i>主题下载</a>';
            $html .= '<span class="badg">密码：请联系客服</span>';
            $html .= '</div>';
            $html .= '<div class="but-download flex ac">';
            $html .= '<a target="_blank" href="#" class="mr10 but c-green"><i class="fa fa-book" aria-hidden="true"></i>使用文档</a>';
            $html .= '<span class="badg">在线查看</span>';
            $html .= '</div>';
        }
        
        $html .= '</div>'; // 关闭 flex ac hh
        $html .= '</div>'; // 关闭内层 div
        $html .= '</div>'; // 关闭 theme-box
        // pay-extra-hide 区域（提示信息、按钮、二维码）
        $html .= '<div class="pay-extra-hide">';
        $html .= '<div class="flex hh ac jsa">';
        $html .= '<div class="mt10 mr20">';
        $html .= '<div class="ml20">';
        $html .= '<li class="c-yellow-2 mb6">请严格遵守授权规范，违规使用将做封号处理<a target="_blank" class="focus-color" href="#">【查看详情】</a></li>';
        $html .= '<li class="c-blue mb6">首次使用请查看<a href="#" target="_blank" class="focus-color">【WordPress搭建教程】</a>、<a href="#" target="_blank" class="focus-color">【主题安装教程及准备】</a></li>';
        $html .= '<li class="c-blue-2 mb6">更新主题推荐使用一键在线更新<a href="#" target="_blank" class="focus-color">【查看教程】</a></li>';
        $html .= '<li class="c-yellow">更新主题请务必<b class="c-red">清空浏览器缓存</b>、<b class="c-red">刷新CDN缓存</b></li>';
        $html .= '</div>';
        $html .= '<div class="mt10 ml10">';
        $html .= '<a target="_blank" href="#" class="but c-blue mt6 mr10"><i aria-hidden="true" class="fa fa-cloud-upload"></i>更新日志</a>';
        $html .= '<a target="_blank" class="but c-blue mt6 mr10" href="#"><i aria-hidden="true" class="fa fa-grav"></i>社区论坛</a>';
        $html .= '<a target="_blank" class="but c-blue mt6 mr10" href="#"><i aria-hidden="true" class="fa fa-bookmark"></i>主题文档</a>';
        $html .= '</div>';
        $html .= '</div>';
        $html .= '<div class="text-center mt20 flex0">';
        $html .= '<div class="c-yellow">';
        $html .= '<img src="https://oss.zibll.com/zibll.com/2022/11/QQ群二维码新.jpg" style="width: 100px">';
        $html .= '</div>';
        $html .= '<div class="mt10">扫码加入正版用户群<div class=""><a class="c-yellow" target="_blank" href="https://jq.qq.com/?_wv=1027&k=S7kr4r0i">QQ群号：744217976</a></div></div>';
        $html .= '</div>';
        $html .= '</div>';
        $html .= '</div>'; // 关闭 pay-extra-hide
        $html .= '</div>'; // 关闭 zib-widget pay-box

    $result = zib_get_ajax_ajaxpager_one_centent($html);
    
    // 设置缓存，缓存5分钟
    wp_cache_set($cache_key, $result, 'mrhe_auth', 300);
    
    return $result;
}
add_filter('main_user_tab_content_product', 'zib_main_user_tab_content_product', 20);

/**
 * 获取用户的所有授权产品
 * @param {int} $user_id 用户ID
 * @param {bool} $only_authorized 是否只返回已授权的
 * @return {array} 授权产品列表
 */
function mrhe_get_user_theme_orders($user_id, $only_authorized = false)
{
    global $wpdb;
    
    $table_name = $wpdb->prefix . 'mrhe_theme_aut';
    $order_table = $wpdb->zibpay_order;
    
    $where_clause = "WHERE a.user_id = %d";
    $params = array($user_id);
    
    if ($only_authorized) {
        // 显示已授权的记录（包括封禁的）
        $where_clause .= " AND a.is_authorized = 1";
    }
    
    $query = "SELECT a.*, o.order_num, o.pay_time, o.pay_price 
              FROM $table_name a 
              LEFT JOIN $order_table o ON a.user_id = o.user_id AND a.post_id = o.post_id 
              $where_clause 
              ORDER BY a.created_at DESC";
    
    $results = $wpdb->get_results($wpdb->prepare($query, $params), ARRAY_A);
    
    return $results ? $results : array();
}

/**
 * 获取用户的所有授权信息
 * @param {int} $user_id 用户ID
 * @return {array} 授权信息数组
 */
function mrhe_get_user_all_auth_info($user_id)
{
    global $wpdb;
    
    $table_name = $wpdb->prefix . 'mrhe_theme_aut';
    $results = $wpdb->get_results($wpdb->prepare(
        "SELECT * FROM $table_name WHERE user_id = %d AND is_authorized = 1",
        $user_id
    ), ARRAY_A);
    
    $auth_info = array();
    foreach ($results as $result) {
        $post_id = $result['post_id'];
        
        // 动态获取 product_id：优先从订单表，后备从产品元数据
        $product_id = mrhe_get_dynamic_product_id($post_id, $result['user_id']);
        
        // 只使用 post_id 作为唯一键
        $auth_info[$post_id] = array(
            'post_id' => $post_id,
            'product_id' => $product_id, // 使用最新的 product_id
            'auth_code' => $result['auth_code'],
            'domains' => maybe_unserialize($result['domain']),
            'max_domains' => (int) $result['aut_max_url'],
            'is_authorized' => (int) $result['is_authorized'],
            'is_banned' => (int) ($result['is_banned'] ?? 0)
        );
    }
    
    return $auth_info;
}

/**
 * 清理用户授权页面缓存
 * 当授权信息更新时自动清理缓存
 */
function mrhe_clear_user_auth_cache($user_id)
{
    $cache_key = 'mrhe_user_auth_content_' . $user_id;
    wp_cache_delete($cache_key, 'mrhe_auth');
}
add_action('mrhe_auth_updated', 'mrhe_clear_user_auth_cache');
add_action('mrhe_domain_updated', 'mrhe_clear_user_auth_cache');

// 显示错误消息函数
function display_error_message($message)
{
    echo '<div class="modal-colorful-header colorful-bg jb-red">
            <!-- 关闭按钮 -->
            <button class="close" data-dismiss="modal">
                <svg class="ic-close" aria-hidden="true">
                    <use xlink:href="#icon-close"></use>
                </svg>
            </button>
            <!-- 头部样式 -->
            <div class="colorful-make"></div>
            <div class="text-center">
                <div class="em2x">
                    <i class="fa fa-times-circle-o fa-2x" aria-hidden="true"></i>
                </div>
            </div>
        </div>
        <div class="em12 text-center c-red" style="padding: 30px 0;">' . $message . '</div>';
}

/**
 * @description: 用户中心侧边栏的第一个：数据统计
 * @param {*} $con
 * @return {*}
 */
function zib_user_center_page_sidebar_statistics($con)
{
    $user_id = get_current_user_id();
    if (!$user_id) {
        return $con;
    }

    $args = array(
        array(
            'name'  => '文章',
            'count' => zib_get_user_post_count($user_id, 'publish'),
            'link'  => zib_get_user_home_url($user_id, array('tab' => 'post')),
        ),
        array(
            'name'  => '评论',
            'count' => get_user_comment_count($user_id),
            'link'  => zib_get_user_home_url($user_id, array('tab' => 'comment')),
        ),
        array(
            'name'  => '收藏',
            'count' => zib_get_user_favorite_count($user_id),
            'link'  => zib_get_user_home_url($user_id, array('tab' => 'favorite')),
        ),
        array(
            'name'  => '粉丝',
            'count' => get_user_followed_count($user_id),
            'link'  => zib_get_user_home_url($user_id, array('tab' => 'follow')),
        ),
    );

    $args = apply_filters('user_sidebar_statistics_args', $args, $user_id);
    $item = '';

    foreach ($args as $arg) {
        $item .= '<a class="user-statistics-item" href="' . $arg['link'] . '"><div class="em14">' . _cut_count($arg['count']) . '</div><div class="em09 opacity5 mt6">' . $arg['name'] . '</div></a>';
    }

    $con .= '<div class="mb10-sm mb20 flex ac jsa zib-widget padding-10 text-center">' . $item . '</div>';
    return $con;
}
add_filter('user_center_page_sidebar', 'zib_user_center_page_sidebar_statistics');

/**
 * @description: 用户中心侧边栏-按钮组
 * @param {*}
 * @return {*}
 */
function zib_user_center_page_sidebar_button_1($con)
{

    $buttons = array(
        array(
            'html' => '',
            'icon' => '',
            'name' => '',
            'tab'  => '',
        ),
    );

    if (_pz('user_level_s', true)) {
        $buttons[] = array(
            'html' => '',
            'icon' => zib_get_svg('trend-color'),
            'name' => '我的等级',
            'tab'  => 'level',
        );
    }

    if (_pz('user_auth_s', true)) {
        $buttons[] = array(
            'html' => '',
            'icon' => zib_get_svg('user-auth'),
            'name' => '官方认证',
            'tab'  => 'auth',
        );
    }
    if (!current_user_can('manage_options')) {
        $buttons[] = array(
            'html' => '',
            'icon' => zib_get_svg('reply'),
            'name' => '我的投诉',
            'tab'  => 'complaint',
        );
    }

    $buttons = apply_filters('zib_user_center_page_sidebar_button_1_args', $buttons);

    $buttons_html = '';
    foreach ($buttons as $but) {
        if (!empty($but['html'])) {
            $buttons_html .= $but['html'];
        } elseif (!empty($but['icon'])) {
            $buttons_html .= '<item class="icon-but-' . $but['tab'] . '" data-onclick="[data-target=\'#user-tab-' . $but['tab'] . '\']" ><div class="em16">' . $but['icon'] . '</div><div class="px12 muted-color mt3">' . $but['name'] . '</div></item>';
        }
    }

    $con .= $buttons_html ? '<div class="zib-widget padding-6 mb10-sm"><div class="padding-6 ml3">我的服务</div><div class="flex ac hh text-center icon-but-box user-icon-but-box">' . $buttons_html . '</div></div>' : '';
    return $con;
}
add_filter('user_center_page_sidebar', 'zib_user_center_page_sidebar_button_1', 50);

// 我的投诉
function zib_main_user_tab_content_complaint()
{
    global $wpdb;

    $user = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;
    if (!$user_id) {
        return;
    }

    // 使用 $wpdb->prepare() 处理 SQL 查询，防止 SQL 注入
    $query = $wpdb->prepare(
        "SELECT status, meta
        FROM {$wpdb->zib_message}
        WHERE send_user = %d",
        $user_id
    );

    // 执行查询
    $results = $wpdb->get_results($query);

    // 内联 CSS 样式
    $style = '
        <style>
            .progress {
                height: 20px;
                position: static;
                background-color: #f2f2f2;
                border-radius: 8px;
                box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }
            .progress-bar {
                height: 100%;
                box-shadow: inset 0 -1px 2px rgba(0, 0, 0, 0.15);
                transition: width 0.6s ease;
                border-radius: 6px;
            }
        </style>
    ';

    // 处理结果
    $form = '';
    $form .= '<div class="alert jb-blue"><b>加入网络监督员维护社区网络环境，举报不良信息，共建和谐绿色社区</b></div>';
    if (!empty($results)) {
        foreach ($results as $row) {
            // 对于每一行结果，$row 是一个对象，可以根据 status 字段的值进行判断
            $status = $row->status;
            // 解析 meta 字段
            $meta_value = $row->meta;
            $meta_array = unserialize($meta_value);
            $user_data = get_userdata($meta_array['report_user_id']); //获取被举报者名字

            if ($status == 1) {
                // "已完成" 显示为进度条的 100% 完成
                $progress = '<p>处理结果：' . $meta_array['process_desc'] . '</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%;">已完成</div>
                            </div>';
            } else {
                // "处理中" 显示为进度条的 50% 完成（可根据实际进度进行调整）
                $progress = '<div class="progress">
                                <div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 50%;">处理中</div>
                            </div>';
            }

            // 在这里处理 meta 值
            $form .= '<div class="mb40">';
            $form .= '<p>被举报用户：' . $user_data->display_name . '</p>';
            $form .= '<p>举报原因：' . $meta_array['desc'] . '</p>';
            $form .= '<p>举报详情：' . $meta_array['reason'] . '</p>';
            $form .= '<p>违规链接：' . $meta_array['url'] . '</p>';
            $form .= '<p>提交时间：' . $meta_array['time'] . '</p>';
            $form .= $progress;
            $form .= '</div>';
        }
    } else {
        $form .= '<div class="mb40">';
        $form .= '<p>没有你的举报记录</p>';
        $form .= '</div>';
    }

    $html = '<form class="my-complaint-form hexsen-complaint zib-widget"><div class="padding-h10" style="max-width: 502px;margin: auto;">' . $style . $form . '</div></form>';
    return zib_get_ajax_ajaxpager_one_centent($html);
}
add_filter('main_user_tab_content_complaint', 'zib_main_user_tab_content_complaint');


/**
 * @description: 用户中心侧边栏-按钮组2
 * @param {*}
 * @return {*}
 */
function zib_user_center_page_sidebar_button_2($con)
{

    $buttons = array(
        array(
            'html' => '',
            'icon' => zib_get_svg('user-color'),
            'name' => '个人资料',
            'tab'  => 'data',
        ),
    );

    if (_pz('post_rewards_s') || _pz('pay_rebate_s')) {
        $buttons[] = array(
            'html' => '',
            'icon' => zib_get_svg('gift-color'),
            'name' => '打赏收款',
            'tab'  => 'rewards',
        );
    }
    $buttons[] = array(
        'html' => '',
        'icon' => zib_get_svg('security-color'),
        'name' => '账户安全',
        'tab'  => 'account',
    );

    $buttons = apply_filters('zib_user_center_page_sidebar_button_2_args', $buttons);

    $buttons_html = '';
    foreach ($buttons as $but) {
        if ($but['html']) {
            $buttons_html .= $but['html'];
        } elseif ($but['icon']) {
            $buttons_html .= '<item class="icon-but-' . $but['tab'] . '" data-onclick="[data-target=\'#user-tab-' . $but['tab'] . '\']" ><div class="em16">' . $but['icon'] . '</div><div class="px12 muted-color mt3">' . $but['name'] . '</div></item>';
        }
    }

    $con .= $buttons_html ? '<div class="zib-widget padding-6"><div class="padding-6 ml3">功能设置</div><div class="flex ac hh text-center icon-but-box user-icon-but-box">' . $buttons_html . '</div></div>' : '';
    return $con;
}
add_filter('user_center_page_sidebar', 'zib_user_center_page_sidebar_button_2', 60);

//修改资料页面
function zib_main_user_tab_content_data()
{

    $user    = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;

    if (!$user_id) {
        return;
    }

    $privacy = zib_get_user_meta($user_id, 'privacy', true);
    $gender  = get_user_meta($user_id, 'gender', true);

    $html            = '';
    $avatar          = zib_get_avatar_box($user_id, 'avatar-img avatar-lg', false, false);
    $avatar_set_link = zib_get_user_avatar_set_link('but c-blue p2-10 em09 ml6 hollow shrink0', '修改头像');

    $html .= '<div class="mb30">
                <div class="author-set-left">' . $avatar . '</div>
                <div class="author-set-right mt10">
                    <div class="flex ac"><b class="em12">' . esc_attr($user->display_name) . '</b>' . $avatar_set_link . '</div>
                    <div class="muted-2-color mt6">注册时间：' . get_date_from_gmt($user->user_registered) . '</div>
                    <div class="muted-2-color mt6">最后登录：' . get_user_meta($user_id, 'last_login', true) . '</div>
              </div>
            </div>';

    $html .= '<div class="mb30">
                <div class="author-set-left">昵称</div>
                <div class="author-set-right">
                    <input type="input" class="form-control" name="name" value="' . esc_attr($user->display_name) . '" placeholder="请输入用户名">
                </div>
            </div>
            <div class="mb30">
                <div class="author-set-left">个人签名</div>
                <div class="author-set-right">
                    <input type="input" class="form-control" name="desc" value="' . esc_attr(get_user_meta($user_id, 'description', true)) . '" placeholder="请简短的介绍自己">
                </div>
            </div>
            <div class="mb30">
                <div class="author-set-left">隐私设置</div>
                <div class="author-set-right form-select">
                    <select class="form-control" name="privacy">
                        <option value="not_show"' . selected('not_show', $privacy, false) . '>社交资料 所有人都不可见</option>
                        <option value="public" ' . selected('public', $privacy, false) . '>社交资料 所有人可见</option>
                        <option value="just_logged" ' . selected('just_logged', $privacy, false) . '>社交资料 仅注册用户可见</option>
                    </select>
                </div>
            </div>
            <div class="mb30">
                <div class="author-set-left">性别</div>
                <div class="author-set-right form-select">
                    <select class="form-control" name="gender">
                        <option value="保密" ' . selected('保密', $gender, false) . '>保密</option>
                        <option value="男" ' . selected('男', $gender, false) . '>男</option>
                        <option value="女" ' . selected('女', $gender, false) . '>女</option>
                    </select>
                </div>
            </div>
            <div class="mb30">
                <div class="author-set-left">居住地</div>
                <div class="author-set-right">
                    <input type="input" class="form-control" name="address" value="' . esc_attr(zib_get_user_meta($user_id, 'address', true)) . '" placeholder="请输入居住地址">
                </div>
            </div>
            <div class="mb30">
                <div class="author-set-left">个人网站</div>
                <div class="author-set-right">
                    <input type="input" class="form-control" name="url_name" value="' . esc_attr(zib_get_user_meta($user_id, 'url_name', true)) . '" placeholder="请输入网站名称">
                    <input type="input" class="form-control" name="url" style="margin-top:10px" value="' . esc_attr($user->user_url) . '" placeholder="请输入网址">
                </div>
            </div>
            <div class="mb30">
                <div class="author-set-left">QQ</div>
                <div class="author-set-right">
                    <input type="input" class="form-control" name="qq" value="' . esc_attr(zib_get_user_meta($user_id, 'qq', true)) . '" placeholder="请输入QQ">
                </div>
            </div>
            <div class="mb30">
                <div class="author-set-left">微信</div>
                <div class="author-set-right">
                    <input type="input" class="form-control" name="weixin" value="' . esc_attr(zib_get_user_meta($user_id, 'weixin', true)) . '" placeholder="请输入微信">
                </div>
            </div>
            <div class="mb30">
                <div class="author-set-left">微博</div>
                <div class="author-set-right">
                    <input type="input" class="form-control" name="weibo" value="' . esc_attr(zib_get_user_meta($user_id, 'weibo', true)) . '" placeholder="请输入微博地址">
                </div>
            </div>
            <div class="mb30">
                <div class="author-set-left">Github</div>
                <div class="author-set-right">
                    <input type="input" class="form-control" name="github" value="' . esc_attr(zib_get_user_meta($user_id, 'github', true)) . '" placeholder="请输入Github地址">
                </div>
            </div>
            <div class="mb10">
                <div class="author-set-left"></div>
                <div class="author-set-right">
                    <input type="hidden" name="user_id" value="' . $user_id . '">
                    <input type="hidden" name="action" value="user_edit_datas">
                    <button type="button" zibajax="submit" class="but jb-blue padding-lg" name="submit"><i class="fa fa-check mr10"></i>确认提交</button>
                </div>
            </div>';

    $html = '<form class="zib-widget">' . $html . '</form>';
    return zib_get_ajax_ajaxpager_one_centent($html);
}
add_filter('main_user_tab_content_data', 'zib_main_user_tab_content_data');

function zib_get_user_avatar_set_link($class = '', $text = '修改头像')
{
    if (!_pz('avatar_upload_s', true)) {
        return;
    }

    $user_id = get_current_user_id();
    if (!$user_id) {
        return;
    }

    $args = array(
        'tag'           => 'a',
        'class'         => 'avatar-set-link ' . $class,
        'mobile_bottom' => true,
        'height'        => 410,
        'text'          => $text,
        'query_arg'     => array(
            'action' => 'user_avatar_set_modal',
        ),
    );

    //每次都刷新的modal
    return zib_get_refresh_modal_link($args);
}

function zib_get_user_cover_set_link($class = '', $text = '修改封面')
{

    if (!_pz('user_cover_upload_s', true)) {
        return;
    }

    $user_id = get_current_user_id();

    if (!$user_id) {
        return;
    }

    $args = array(
        'tag'           => 'a',
        'class'         => 'avatar-set-link ' . $class,
        'mobile_bottom' => true,
        'height'        => 330,
        'text'          => $text,
        'query_arg'     => array(
            'action' => 'user_cover_set_modal',
        ),
    );

    //每次都刷新的modal
    return zib_get_refresh_modal_link($args);
}

function zib_get_user_collection_set_link($class = '', $text = '收款设置', $new_modal = false)
{
    $user_id = get_current_user_id();
    if (!$user_id) {
        return;
    }

    $args = array(
        'tag'           => 'a',
        'class'         => 'collection-set-link ' . $class,
        'mobile_bottom' => true,
        'height'        => 423,
        'text'          => $text,
        'query_arg'     => array(
            'action' => 'user_collection_set_modal',
        ),
    );
    if ($new_modal) {
        $args['new'] = true;
    }

    //每次都刷新的modal
    return zib_get_refresh_modal_link($args);
}

//获取用户中心绑定邮箱等功能的按钮
function zib_get_user_set_link($class = '', $tab = '', $text = '')
{
    $user_id = get_current_user_id();
    if (!$user_id) {
        return;
    }

    $args = array(
        'tag'           => 'a',
        'class'         => 'collection-set-link ' . $class,
        'mobile_bottom' => true,
        'height'        => 220,
        'data_class'    => 'modal-mini',
        'text'          => $text,
        'query_arg'     => array(
            'tab'    => $tab,
            'action' => 'user_set_modal',
        ),
    );

    //每次都刷新的modal
    return zib_get_refresh_modal_link($args);
}

/**
 * @description: 头像设置的模态框
 * @param {*}
 * @return {*}
 */
function zib_get_user_avatar_set_modal()
{
    $user_id = get_current_user_id();
    if (!$user_id) {
        return;
    }

    $add = ZIB_TEMPLATE_DIRECTORY_URI . '/img/upload-add.svg';

    $form = '<form class="mini-upload">';
    $form .= '<div class="form-upload mb20">';
    $form .= '<p class="muted-2-color">选择一张图片作为头像，支持jpg、gif格式，最大' . zib_get_current_user_can_number('upload_img_size', 3) . 'M，建议尺寸150x150</p>';
    $form .= '<label class="pointer flex ac" style="width: 100%;">';
    $form .= '<div class="preview upload-preview radius4" style="width: 140px;height: 140px;">'; //正方形
    $form .= '<img class="fit-cover" src="' . $add . '">';
    $form .= '</div>';
    $form .= '<div class="preview upload-preview radius">'; //正方形
    $form .= '<img class="fit-cover" src="' . $add . '">';
    $form .= '</div>';
    $form .= '<input class="hide" type="file" zibupload="image_upload" accept="image/gif,image/jpeg,image/jpg" name="image_upload" action="image_upload">';
    $form .= '</label>';
    $form .= '</div>';

    $form .= '<div class="modal-buts but-average"><button type="button" action="info.upload" zibupload="submit" class="but c-blue" name="submit"><i class="fa fa-check mr10"></i>确认修改</button></div>';

    $form .= wp_nonce_field('upload_avatar', 'upload_avatar_nonce', false, false) . '<input type="hidden" name="user_id" value="' . $user_id . '"><input type="hidden" name="action" value="user_upload_avatar">';
    $form .= '</form>';

    $header = zib_get_modal_colorful_header('jb-blue', zib_get_svg('circle'), '修改头像');

    $html = $header . $form;

    return $html;
}

/**
 * @description: 封面设置的模态框
 * @param {*}
 * @return {*}
 */
function zib_get_user_cover_set_modal()
{
    $user_id = get_current_user_id();
    if (!$user_id) {
        return;
    }

    $add = ZIB_TEMPLATE_DIRECTORY_URI . '/img/upload-add.svg';

    $form = '<form class="mini-upload">';
    $form .= '<div class="form-upload mb20">';
    $form .= '<p class="muted-2-color">选择一张深色图片作为个人封面，支持jpg、gif格式，最大' . zib_get_current_user_can_number('upload_img_size', 3) . 'M，建议尺寸1000x500</p>';
    $form .= '<label class="pointer" style="width: 100%;">';
    $form .= '<div class="cover-preview radius8 relative">';
    $form .= '<div class="preview-container preview abs-center">';
    $form .= '<img class="fit-cover" src="' . $add . '">';
    $form .= '</div>';
    $form .= '</div>';
    $form .= '<input class="hide" type="file" zibupload="image_upload" accept="image/gif,image/jpeg,image/jpg" name="image_upload" action="image_upload">';
    $form .= '</label>';
    $form .= '</div>';

    $form .= '<div class="modal-buts but-average"><button type="button" action="info.upload" zibupload="submit" class="but c-blue" name="submit"><i class="fa fa-check mr10"></i>确认修改</button></div>';

    $form .= wp_nonce_field('upload_cover', 'upload_cover_nonce', false, false) . '<input type="hidden" name="user_id" value="' . $user_id . '"><input type="hidden" name="action" value="user_upload_cover">';
    $form .= '</form>';

    $header = zib_get_modal_colorful_header('jb-blue', zib_get_svg('circle'), '修改个人封面');
    $html   = $header . $form;

    return $html;
}

function zib_main_user_tab_content_account()
{

    $user    = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;
    if (!$user_id) {
        return;
    }

    $con   = '';
    $email = $user->user_email;

    if ($email) {
        $btn  = zib_get_user_set_link('but c-yellow-2 p2-10 but hollow', 'email', '修改');
        $desc = '' . esc_attr($email);
    } else {
        $btn  = zib_get_user_set_link('but c-blue p2-10 but hollow', 'email', '绑定');
        $desc = '暂未绑定';
    }

    $con .= '<div class="oauth-bind-box"><div class=""><div class="flex ac jsb muted-box">
                <div class="flex ac type-logo"><span class="b-blue circular mr6 em14"><i class="fa fa-envelope"></i></span><span class="">邮箱</span></div>
                <div class="overflow-hidden"><div class="text-ellipsis muted-2-color">' . $desc . '</div></div>
                <div class="shrink0">' . $btn . '</div>
                </div></div></div>';

    $title = '<div class="title-h-left"><b>绑定邮箱</b></div>';
    $title .= '<div class="muted-2-color mb20">绑定邮箱账号，及时接收订单、审核等重要信息</div>';

    $html = '<div class="box-body">' . $title . $con . '</div>';
    $html = apply_filters('user_center_account_setup', $html, $user_id, $user); //设置
    $html = '<div class="zib-widget account-set nopw-sm">' . $html . '</div>';

    return zib_get_ajax_ajaxpager_one_centent($html);
}
add_filter('main_user_tab_content_account', 'zib_main_user_tab_content_account');

if (_pz('user_bind_option', false, 'bind_phone')) {
    add_filter('user_center_account_setup', 'zib_oauth_phone_set', 10, 2);
}
function zib_oauth_phone_set($html, $user_id)
{

    if (!$user_id) {
        return;
    }

    $phone = zib_get_user_phone_number($user_id);
    $con   = '';

    if ($phone) {
        $btn  = zib_get_user_set_link('but c-yellow p2-10 but hollow', 'phone', '修改');
        $desc = '' . esc_attr($phone);
    } else {
        $btn  = zib_get_user_set_link('but c-blue p2-10 but hollow', 'phone', '绑定');
        $desc = '暂未绑定';
    }

    $con .= '<div class="oauth-bind-box"><div class=""><div class="flex ac jsb muted-box">
                <div class="flex ac type-logo"><span class="b-blue-2 circular mr6 em14"><i class="fa fa-phone"></i></span><span class="">手机号</span></div>
                <div class="muted-2-color">' . $desc . '</div>
                <div class="">' . $btn . '</div>
                </div></div></div>';

    $title = '<div class="title-h-left"><b>绑定手机</b></div>';
    $title .= '<div class="muted-2-color mb20">绑定手机号，提高账户安全性</div>';

    return $html . '<div class="box-body">' . $title . $con . '</div>';
}

function zib_oauth_set($html, $user_id)
{
    if (!$user_id || _pz('social')) {
        return;
    }

    $con  = '';
    $rurl = zib_get_user_center_url('account');
    $args = zib_get_social_type_data();

    foreach ($args as $arg) {
        $name = $arg['name'];
        $type = $arg['type'];
        $icon = zib_get_cfs_icon($arg['icon']);

        $bind_href = zib_get_oauth_login_url($type, $rurl);
        if ($bind_href) {
            $oauth_info = zib_get_user_meta($user_id, 'oauth_' . $type . '_getUserInfo', true);
            $oauth_id   = get_user_meta($user_id, 'oauth_' . $type . '_openid', true);
            if ($oauth_info && $oauth_id) {
                //已绑定
                $user_name   = !empty($oauth_info['name']) ? esc_attr($oauth_info['name']) : (!empty($oauth_info['nick_name']) ? esc_attr($oauth_info['nick_name']) : $name . '账号');
                $user_avatar = !empty($oauth_info['avatar']) ? $oauth_info['avatar'] : '';

                if ($user_avatar) {

                    //优化百度头像地址
                    $user_avatar = str_replace('tb.himg.baidu.com', 'himg.bdimg.com', $user_avatar);
                    $user_avatar = preg_replace('/^(https:|http:)/', '', $user_avatar);

                    $lazy_attr   = zib_get_lazy_attr('lazy_avatar', $user_avatar, 'avatar', ZIB_TEMPLATE_DIRECTORY_URI . '/img/thumbnail-null.svg');
                    $user_avatar = '<span class="avatar-img avatar-sm mr6" style="--this-size: 22px;"><img ' . $lazy_attr . ' alt="' . $name . '头像' . zib_get_delimiter_blog_name() . '"></span>';
                }

                //$desc = $user_avatar ? $user_avatar . $user_name : '已绑定“' . $user_name . '”';
                $desc = $user_avatar ? $user_avatar . $user_name : '已绑定"' . $user_name . '"';
                $desc = '<div class="muted-2-color text-ellipsis mr10 ml20"  data-toggle="tooltip"  title="已绑定' . $name . '账号">' . $desc . '</div>';
                $btn  = '<a data-toggle="tooltip" href="javascript:;" openid="' . esc_attr($oauth_id) . '" title="解绑' . $name . '账号" user-id="' . $user_id . '" untying-type="' . $type . '" class="em09 p2-10 oauth-untying but hollow c-yellow">解绑</a>';

            } else {
                //还未绑定
                if ('alipay' == $type) {
                    if (wp_is_mobile() && !strpos($_SERVER['HTTP_USER_AGENT'], 'Alipay')) {
                        continue;
                    }
                    //移动端并且不是支付宝APP不显示支付宝
                }

                $class = '';
                if (!empty($arg['qrcode'])) {
                    $class .= ' qrcode-signin';
                }

                $desc = '<div class="muted-2-color">暂未绑定</div>';
                $btn  = '<a title="绑定' . $name . '账号" href="' . esc_url(add_query_arg(array('bind' => $type), $bind_href)) . '" class="em09 p2-10 but hollow ' . $class . ' c-blue">绑定</a>';
            }

            $con .= '<div class="mb10"><div class="flex ac jsb muted-box">
                        <div class="flex ac type-logo"><span class="social-login-item circular mr6 em14 ' . $type . '">' . $icon . '</span><span class="">' . $name . '</span></div>
                        <div class="overflow-hidden">' . $desc . '</div>
                        <div class="shrink0">' . $btn . '</div>
                    </div></div>';

        }
    }

    if (!$con) {
        return $html;
    }

    $html .= '<div class="box-body oauth-set">';
    $html .= '<div class="title-h-left"><b>绑定社交账号</b></div><div class="muted-2-color mb20">绑定社交账号，您可更安全、更快速的登录本站</div>';
    $html .= '<div class="flex hh oauth-bind-box gutters-5">' . $con . '</div>';
    $html .= '</div>';
    return $html;
}
add_filter('user_center_account_setup', 'zib_oauth_set', 10, 2);

function zib_passwordold_set($html, $user_id)
{
    $oauth_new = get_user_meta($user_id, 'oauth_new', true);

    $subtitle = $oauth_new ? '您还未设置过密码，请在此设置新密码' : '定期修改密码有助于账户安全';
    $btn      = zib_get_user_set_link('but c-blue-2 hollow', 'change_password', ($oauth_new ? '设置新密码' : '修改密码'));

    $con = '<div class="oauth-bind-box"><div class=""><div class="flex ac jsb muted-box">
                <div class="flex ac type-logo"><span class="b-purple circular mr6 em14"><i class="fa fa-unlock-alt"></i></span><span class="">账户密码</span></div>
                <div class="">' . $btn . '</div>
                </div></div></div>';

    $con   = '<div>' . $con . '</div>';
    $title = '<div class="title-h-left"><b>账户密码</b></div>';
    $title .= '<div class="muted-2-color mb20">' . $subtitle . '</div>';

    return $html . '<div class="box-body">' . $title . $con . '</div>';
}
add_filter('user_center_account_setup', 'zib_passwordold_set', 10, 2);

//绑定用户微信的模态框
function zib_user_center_oauth_qrcode_modal()
{
    if (zib_is_oauth_qrcode_s() && zib_weixingzh_is_qrcode()) {
        add_action('wp_footer', 'zib_oauth_qrcode_modal', 11, 2);
    }
}
add_action('user_center_page_content', 'zib_user_center_oauth_qrcode_modal');

function zib_oauth_qrcode_modal($html)
{
    $tab_html = '<div class="tab-pane fade active in" id="tab-qrcode-signin">';
    $tab_html .= '<div class="box-body">';
    $tab_html .= '<div class="title-h-left em12">绑定微信账号</div>';
    $tab_html .= '<a class="muted-color px12 hide" href="#tab-qrcode-signin" data-toggle="tab">扫码登录</a>';
    $tab_html .= '</div>';
    $tab_html .= '<div class="qrcode-signin-container box-body text-center">';
    $tab_html .= '<p class="placeholder" style="height:180px;width:180px;margin:auto;"></p><p class="placeholder" style="height:27px;width:200px;margin:15px auto 0;"></p>';
    $tab_html .= '</div>';
    $agreement = zib_get_user_agreement('扫码绑定即表示同意');
    if ($agreement) {
        $tab_html .= '<div class="muted-color mt10 text-center px12 opacity8">' . $agreement . '</div>';
    }
    $tab_html .= '</div>';

    $html .= '<div class="modal fade" id="u_sign" tabindex="-1" role="dialog">';
    $html .= '<div class="modal-dialog" role="document">';
    $html .= '<div class="sign-content">';
    $html .= '<div class="sign zib-widget blur-bg relative">';
    $html .= '<button class="close" data-dismiss="modal">' . zib_get_svg('close', '0 0 1024 1024', 'ic-close') . '</button>';
    $html .= $tab_html;
    $html .= '</div>';
    $html .= '</div>';
    $html .= '</div>';
    $html .= '</div>';
    echo $html;
    //return $html;
}

//用户中心-收款码设置 rewards
function zib_main_user_tab_content_rewards()
{
    $user    = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;
    if (!$user_id) {
        return;
    }

    $post_rewards_s = _pz('post_rewards_s');
    $rewards_title  = zib_get_user_meta($user_id, 'rewards_title', true);

    $form = '';
    if ($post_rewards_s) {
        $form .= '<div class="mb40">';
        $form .= '<div class="title-h-left"><b>设置打赏标题</b></div>';
        $form .= '<div class="line-form">';
        $form .= '<input type="input" class="line-form-input" name="rewards_title" value="' . esc_attr($rewards_title) . '" placeholder="文章很赞！支持一下吧">';
        $form .= '<i class="line-form-line"></i>';
        $form .= '</div>';
        $form .= '</div>';
    }

    $form .= '<div class="mb40">';
    $form .= '<div class="title-h-left"><b>设置收款码</b></div>';
    $form .= '<p class="muted-2-color">选择您的收款码上传，支持jpg、gif、png格式，最大' . zib_get_current_user_can_number('upload_img_size', 3) . 'M</p>';
    $form .= zib_get_user_collection_upload_centent();
    $form .= '</div>';

    $form .= '<div class="mt10 text-center">';
    $form .= '<button type="button" action="info.upload" zibupload="submit" zibupload-nomust="true" class="but jb-blue padding-lg" name="submit"><i class="fa fa-check mr10"></i>确认修改</button>';
    $form .= '</div>';

    $html = '<form class="set-rewards-form mini-upload zib-widget"><div class="padding-h10" style="max-width: 502px;margin: auto;">' . $form . '</div></form>';
    return zib_get_ajax_ajaxpager_one_centent($html);
}
add_filter('main_user_tab_content_rewards', 'zib_main_user_tab_content_rewards');

/**
 * @description: 收款码修改的内容
 * @param {*}
 * @return {*}
 */
function zib_get_user_collection_upload_centent()
{
    $user    = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;
    if (!$user_id) {
        return;
    }

    $rewards_img_urls = zib_get_user_rewards_img_urls($user_id);
    $weixin           = $rewards_img_urls['weixin'];
    $alipay           = $rewards_img_urls['alipay'];
    $add              = '<img style="width: 100%;" src="' . ZIB_TEMPLATE_DIRECTORY_URI . '/img/upload-add.svg" alt="点击上传收款码">';

    $weixin_img = $weixin ? '<img class="fit-cover" src="' . esc_attr($weixin) . '" alt="微信收款码">' : $add;
    $alipay_img = $alipay ? '<img class="fit-cover" src="' . esc_attr($alipay) . '" alt="支付宝收款码">' : $add;

    $html = '<div class="flex ac">';
    $html .= '<label style="width: 100%;" class="pointer text-center">
                <div class="preview weixin upload-preview radius4" style="width: 140px;height: 140px;">' . $weixin_img . '</div>
                <div class="em09 c-blue">上传微信二维码</div>
                <input class="hide" type="file" zibupload="image_upload" data-preview=".preview.weixin" accept="image/gif,image/jpeg,image/jpg,image/png" data-tag="weixin" name="image_upload" action="image_upload">
            </label>';
    $html .= '<label style="width: 100%;" class="pointer text-center">
                <div class="preview alipay upload-preview radius4" style="width: 140px;height: 140px;">' . $alipay_img . '</div>
                <div class="em09 c-blue">上传支付宝二维码</div>
                <input class="hide" type="file" zibupload="image_upload" data-preview=".preview.alipay" accept="image/gif,image/jpeg,image/jpg,image/png" data-tag="alipay" name="image_upload" action="image_upload">
            </label>';

    $html .= '</div>';
    $html .= '<input type="hidden" name="user_id" value="' . $user_id . '">';
    $html .= '<input type="hidden" name="action" value="user_set_rewards">';
    $html .= wp_nonce_field('upload_rewards', 'upload_rewards_nonce', false, false);

    return $html;
}

//获取修改收款码的模态框内容
function zib_get_user_collection_modal()
{

    $user    = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;
    if (!$user_id) {
        return;
    }

    $form = '<div class="mb20">';
    $form .= '<div class="muted-2-color">选择您的收款码上传，支持jpg、gif、png格式，最大' . zib_get_current_user_can_number('upload_img_size', 3) . 'M</div>';
    $form .= zib_get_user_collection_upload_centent();
    $form .= '</div>';
    $form .= '<div class="modal-buts but-average">';
    $form .= '<a type="button" data-dismiss="modal" class="but" href="javascript:;">取消</a><button type="button" action="info.upload" zibupload="submit" class="but c-blue padding-lg" name="submit"><i class="fa fa-check mr10"></i>确认修改</button>';
    $form .= '</div>';

    $html   = '<form class="set-rewards-form mini-upload">' . $form . '</form>';
    $header = zib_get_modal_colorful_header('jb-blue', '<i class="fa fa-qrcode"></i>', '设置收款码');

    return $header . $html;
}

//为用户中心页面添加head
function zib_user_center_seo()
{
    global $new_title, $new_description;
    $user    = wp_get_current_user();
    $user_id = isset($user->ID) ? (int) $user->ID : 0;

    if ($user_id) {
        $new = $user->display_name . '的用户中心';
    } else {
        $new = '用户中心';
    }
    $new .= zib_get_delimiter_blog_name();
    $new_title = $new_description = $new;
    add_filter('echo_seo_title', '__return_true');
}
add_action('locate_template_user_center', 'zib_user_center_seo');

//为用户中心页面添加小工具
add_action('user_center_page_content', function () {
    echo '<div class="fluid-widget">';
    dynamic_sidebar('all_top_fluid');
    dynamic_sidebar('user_top_fluid');
    echo '</div>';
}, 9);
add_action('user_center_page_footer', function () {
    echo '<div class="container fluid-widget">';
    dynamic_sidebar('user_bottom_fluid');
    dynamic_sidebar('all_bottom_fluid');
    echo '</div>';
});

/**
 * @description: 处理导入订单请求（通过授权码查询订单）
 * @return {*}
 */
function mrhe_query_autordery()
{
    //验证用户登录
    if (!is_user_logged_in()) {
        zib_send_json_error('请先登录');
    }

    $user_id  = get_current_user_id();
    $aut_code = isset($_POST['aut_code']) ? strip_tags(trim($_POST['aut_code'])) : '';

    //调试日志
    if (defined('WP_DEBUG') && WP_DEBUG) {
        error_log('mrhe_query_autordery: user_id=' . $user_id . ', aut_code=' . $aut_code);
    }

    //验证授权码
    if (empty($aut_code)) {
        zib_send_json_error('请输入授权码');
    }

    global $wpdb;
    $auth_table = $wpdb->prefix . 'mrhe_theme_aut';

    //查询授权记录
    $auth_record = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $auth_table WHERE auth_code = %s",
        $aut_code
    ), ARRAY_A);

    if (!$auth_record) {
        zib_send_json_error('授权码不存在或已失效');
    }

    //检查授权码是否已被其他用户使用
    if ($auth_record['user_id'] != 0 && $auth_record['user_id'] != $user_id) {
        zib_send_json_error('该授权码已被其他用户使用');
    }

    //如果授权码已经关联到当前用户
    if ($auth_record['user_id'] == $user_id) {
        zib_send_json_success(array('msg' => '该授权码已在您的账户中', 'reload' => 1));
    }

    //关联授权记录到当前用户
    $updated = $wpdb->update(
        $auth_table,
        array('user_id' => $user_id),
        array('id' => $auth_record['id'])
    );

    if ($updated !== false) {
        //清除缓存
        wp_cache_delete('user_theme_orders_' . $user_id, 'mrhe_auth');

        zib_send_json_success(array('msg' => '导入成功！授权已关联到您的账户', 'reload' => 1));
    } else {
        zib_send_json_error('导入失败，请稍后重试');
    }
}
add_action('wp_ajax_mrhe_query_autordery', 'mrhe_query_autordery');
