const poster=function(){function t(t){const d=document.querySelector(t.selector),c=n("div","id","wrapper"),g=n("canvas","id","canvas","block"),p=n("canvas","id","day"),f=n("canvas","id","date"),w=n("canvas","id","title"),u=n("canvas","id","content"),m=n("canvas","id","tags"),b=n("canvas","id","logo"),x=n("canvas","id","description");l(c,g,p,f,w,u,b,m,x),d.appendChild(c);const y=new Date,v=["日","一","二","三","四","五","六"],S={font:"35px Arial",color:"rgba(255, 255, 255, 1)",position:"left"};r(p,S,"周"+v[y.getDay()]);const A={font:"28px Arial",color:"rgba(255, 255, 255, 1)",position:"left"};r(f,A,y.getMonth()+1+" / "+y.getDate());const _={font:"bold 35px Arial",lineHeight:1.5,color:"#424242",length:2,position:"left"};_.font=t.titleStyle&&t.titleStyle.font||_.font,_.color=t.titleStyle&&t.titleStyle.color||_.color,_.position=t.titleStyle&&t.titleStyle.position||_.position,a(w,_,t.title);const k={font:"25px Arial",lineHeight:1.5,position:"left",color:"rgba(88, 88, 88, 1)"};k.font=t.contentStyle&&t.contentStyle.font||k.font,k.color=t.contentStyle&&t.contentStyle.color||k.color,k.lineHeight=t.contentStyle&&t.contentStyle.lineHeight||k.lineHeight,k.position=t.contentStyle&&t.contentStyle.position||k.position,a(u,k,t.content);const T={font:"24px Roboto Slab",position:"left",color:"#fc4e1f"};T.color=t.tagsStyle&&t.tagsStyle.color||T.color,a(m,T,t.tags);const I={font:"22px Arial",color:"#b4b4b4",lineHeight:1.2,position:"center"};a(x,I,t.description);const H=new Image;H.crossOrigin="Anonymous";const C=new Image;var W=0;C.crossOrigin="Anonymous",C.src=t.logo,C.onerror=function(){W++,W<3&&(C.src=t.logo)};const j=new Image;j.src=t.qrcode;var q=0;const R=function(){0==q&&(t.banner?H.src=t.banner:q=1),1==q&&(t.banner_default?H.src=t.banner_default:q=2),2==q&&(H.src=t.banner_spare),D()},D=function(){g.width=s,g.height=h,H.onload=function(){const n=g.getContext("2d");n.fillStyle="rgba(255, 255, 255, 1)",n.fillRect(0,0,g.width,g.height);var l="product"===t.type?g.width:g.height/2;const r=o(g.width,l,H.width,H.height);if(n.drawImage(H,r.sx,r.sy,r.sWidth,r.sHeight,0,0,g.width,l),n.drawImage(p,0,35),n.drawImage(f,0,85),n.strokeStyle="#00a1ff",n.lineWidth=7,n.beginPath(),n.lineCap="round",n.moveTo(40,l+38),n.lineTo(40,l+74),n.stroke(),"product"===t.type){e(n,t.title,g.width,1,"bold 35px Arial","#424242",50,20,l+69);var a,b,y,v,S=t.is_points?"#ff6f06":"#FB3961",A=t.is_points?"积分":"￥",_=l+69+50+20;t.is_points?(a=e(n,t.price,g.width,1,"bold 40px Arial",S,50,0,_),b=e(n,A,g.width,1,"22px Arial",S,50,4+a.width,_-2),t.original_price&&(y=e(n,t.original_price,g.width-a.width-b.width,1,"25px Arial","#878787",50,8+a.width+b.width,_),v=e(n,A,g.width-a.width-b.width,1,"22px Arial","#878787",50,10+a.width+b.width+y.width,_-1),n.strokeStyle="#878787",n.lineWidth=2,n.beginPath(),n.lineCap="round",n.moveTo(8+a.width+b.width+42,_-15),n.lineTo(8+a.width+b.width+42+v.width+y.width,_-3),n.stroke())):(b=e(n,A,g.width,1,"26px Arial",S,50,-10,_-1),a=e(n,t.price,g.width,1,"bold 40px Arial",S,50,-10+b.width,_),t.original_price&&(v=e(n,A,g.width-a.width-b.width,1,"23px Arial","#878787",50,0+a.width+b.width,_-1),y=e(n,t.original_price,g.width-a.width-b.width,1,"25px Arial","#878787",50,0+a.width+b.width+v.width,_),n.strokeStyle="#878787",n.lineWidth=2,n.beginPath(),n.lineCap="round",n.moveTo(0+a.width+b.width+42,_-15),n.lineTo(0+a.width+b.width+42+v.width+y.width,_-3),n.stroke()));var k=a.width+b.width+(v&&v.width?v.width:0)+(y&&y.width?y.width:0),T=g.width-k-20;T>200&&e(n,t.tags,T,1,"25px Arial","#fc4545",50,k+50,_)}else n.drawImage(w,20,l+40),n.drawImage(m,0,l+160),n.drawImage(u,0,l+220);n.strokeStyle="rgba(122, 122, 122, 0.2)",n.lineWidth=2,n.rect(30,g.height-230,g.width-60,200),n.stroke();const I=i(80,g.height-190,300,100,C.width,C.height);n.drawImage(C,I.dx,I.dy,I.dWidth,I.dHeight),n.drawImage(j,g.width-200,g.height-200,120,120),n.drawImage(x,0,g.height-60);const W=new Image;W.crossOrigin="Anonymous",W.src=g.toDataURL("image/png");const q=t.radio||.7;W.width=s*q,W.height=h*q,W.className="loaded-img",n.clearRect(0,0,g.width,g.height),g.style.display="none",d.querySelector(".loaded-img")?d.querySelector(".loaded-img").src=W.src:d.appendChild(W),d.removeChild(c),d.classList.add("loaded"),$.isFunction(t.callback)&&t.callback(d)},H.onerror=function(){if(q++,q>=3)return $.isFunction(t.onerror)&&t.onerror(d);R()}};R()}function e(t,e,i,o,n,l,r,a,d){let s=[],h="",c=[];if(i-=120,a+=38,e=e.replace(/[\r\n]/g,""),s=e.split(""),t.fillStyle=l,t.font=n,t.measureText(e).width<=i)c.push(e);else for(let e=0;e<s.length;e++){if(c.length==o&&e<s.length-1){c[c.length-1]+="...";break}t.measureText(h).width<i?(h+=s[e],e===s.length-1&&c.push(h)):(e--,c.push(h),h="")}var g=0;for(let e=0;e<c.length;e++)g=Math.max(g,t.measureText(c[e]).width),t.fillText(c[e],a,d+e*r,i);return{width:g,height:c.length*r}}function i(t,e,i,o,n,l){var r=t,a=e,d=i,s=o;return n>l||n==l&&i<o?(s=l*d/n,a=e+(o-s)/2):(n<l||n==l&&i>o)&&(d=n*s/l,r=t+(i-d)/2),{dx:r,dy:a,dWidth:d,dHeight:s}}function o(t,e,i,o){var n=0,l=0,r=i,a=o;return i>o||i==o&&t<e?(r=t*a/e,n=(i-r)/2):(i<o||i==o&&t>e)&&(a=e*r/t,l=(o-a)/2),{sx:n,sy:l,sWidth:r,sHeight:a}}function n(t,e,i,o="none"){const n=document.createElement(t);return n.setAttribute(e,i),n.style.display=o,n.width=s,n}function l(t,...e){e.forEach(e=>{t.appendChild(e)})}function r(t,e,i){const o=t.getContext("2d");t.height=parseInt(e.font.match(/\d+/),10)+20,o.font=e.font,o.fillStyle=e.color,o.textBaseline="top";let n=0,l=0,r=!1;for(let e=0;e<i.length;e++)if(n+=o.measureText(i[e]).width,n>t.width-60){r=!0,l=e;break}let a=30;r&&(i=i.substring(0,l),a=t.width/2-n/2),d&&(o.strokeStyle="#6fda92",o.strokeRect(0,0,t.width,t.height)),"center"===e.position?(o.textAlign="center",o.fillText(i,t.width/2,2)):"left"===e.position?o.fillText(i,a,2):(o.textAlign="right",o.fillText(i,t.width-a,2))}function a(t,e,i){const o=t.getContext("2d"),n=parseInt(e.font.match(/\d+/),10);d&&(o.strokeStyle="#6fda92",o.strokeRect(0,0,t.width,t.height)),o.font=e.font,o.fillStyle=e.color,o.textBaseline="top",o.textAlign="center";let l=0;"center"===e.position?l=t.width/2:"left"===e.position?(o.textAlign="left",l=40):(o.textAlign="right",l=t.width-40);let r=0,a=0,s=2;for(let d=0;d<i.length;d++)r+=o.measureText(i[d]).width,r>t.width-120&&(o.fillText(i.substring(a,d),l,s),s+=n*e.lineHeight,r=0,a=d),d===i.length-1&&o.fillText(i.substring(a,d+1),l,s)}const d=0,s=768,h=1168;return{init:t}}();$("body").on("click","[poster-share]",function(){function t(t){if(null!=t){r.find(".poster-download").attr("href",r.find("img").attr("src")).attr("download","poster_"+i+".png").removeClass("hide");var e=r.find(".poster-imgbox").outerHeight();r.find(".loading-mask").fadeOut(200),r.find(".modal-content").css({height:e,transition:".2s"}),setTimeout(function(){r.find(".modal-content").css({height:"",overflow:"",transition:""})},200)}}var e=$(this),i=e.attr("poster-share"),o="modal_poster_"+i,n="#"+o,l='<div class="modal fade flex jc" id="'+o+'" tabindex="-1" role="dialog" aria-hidden="false">    <div class="modal-dialog poster-share hover-show" role="document">    <div class="modal-content" style="height:220px;overflow:hidden">    <div class="poster-imgbox hover-show">    </div>    <div class="flex jc loading-mask absolute main-bg radius8"><div class="loading zts fa-2x"></div><div class="muted-2-color box-body">正在生成图片，请稍候...</div>    </div>    </div>    <div class="padding-6 abs-center hover-show-con text-center" style="top:auto;"><a type="button" href="javascript:;" class="but cir jb-blue poster-download hide"><i class="fa fa-download" aria-hidden="true"></i></a><button data-dismiss="modal" class="but cir jb-yellow ml10"><svg aria-hidden="true" class="icon em12"><use xlink:href="#icon-close"></use></svg></button></div>    </div>    </div>';$(".modal:not("+n+")").modal("hide");var r=$(n);if(r.length)return r.modal("show"),!1;$("body").append(l),r=$(n),r.modal("show");var a={action:"poster_share_data",id:i};zib_ajax(e,a,function(e){poster.init({banner:e.banner,banner_default:e.banner_default,banner_spare:e.banner_spare,selector:n+" .poster-imgbox",title:e.title,content:e.content,logo:e.logo,tags:e.tags,description:e.description,qrcode:e.qrcode,type:e.type,is_points:e.is_points,price:e.price,original_price:e.original_price,onerror:function(){notyf("海报加载失败","danger")},callback:t})},"stop",!0)});