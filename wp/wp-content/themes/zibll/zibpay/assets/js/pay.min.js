function GetRequest(a){var e=window.parent.location.search||_win.url_request||"";if(-1!=e.indexOf("?")){var t=e.substr(1);t.indexOf(!0)&&(t=t.substr(0));for(var i=t.split("&"),n=0;n<i.length;n++)if(-1!=i[n].indexOf(a))return i[n].split("=")[1]}return null}function delQueStr(a,e){var t="";if(e=e||window.location.href,-1==e.indexOf("?"))return e;t=e.substr(e.indexOf("?")+1);var i="",n="";if(-1!=t.indexOf("&")){for(var o in i=t.split("&"),i)i[o].split("=")[0]!=a&&(n=n+i[o].split("=")[0]+"="+i[o].split("=")[1]+"&");return e.substr(0,e.indexOf("?"))+"?"+n.substr(0,n.length-1)}return i=t.split("="),i[0]==a?e.substr(0,e.indexOf("?")):e}(function(a){function e(){var e='<div class="modal fade flex jc" style="display:none;" id="'+b+'" tabindex="-1" role="dialog" aria-hidden="false">        <div class="modal-dialog" role="document">            <div class="pay-payment alipay">                <div class="modal-body modal-pay-body">                    <div class="row-5 hide-sm">                        <img class="lazyload pay-sys t-wechat" alt="alipay" src="" data-src="'+m.uri+'/zibpay/assets/img/alipay-sys.png">                        <img class="lazyload pay-sys t-alipay" alt="wechat" src="" data-src="'+m.uri+'/zibpay/assets/img/wechat-sys.png">                    </div>                    <div class="row-5">                    <div class="pay-qrcon">                        <button class="but cir hollow abs-center right-top nowave" data-dismiss="modal"><svg class="ic-close" aria-hidden="true"><use xlink:href="#icon-close"></use></svg></button>                        <div class="qrcon">                            <div class="pay-logo-header mb10 flex jc"><span class="pay-logo"></span><span class="pay-logo-name t-wechat">支付宝</span><span class="pay-logo-name t-alipay">微信支付</span><span class="pay-over-time em09"></span></div>                            <div class="pay-title em09 muted-2-color padding-h6"></div>                            <div><span class="em09">￥</span><span class="pay-price em14"></span></div>                            <div class="pay-qrcode">                                <img src="" alt="pay-qrcode">                            </div>                        </div>                    <div class="pay-switch"></div>                    <div class="pay-notice"><div class="notice load">正在生成订单，请稍候</div></div>                    </div>\t\t\t\t</div>                </div>            </div>        </div>    </div>';a("link#zibpay_css").length||a("head").append('<link type="text/css" id="zibpay_css" rel="stylesheet" href="'+m.uri+"/zibpay/assets/css/main.css?ver="+m.ver+'">'),a("#"+b).length||v.append(e),a(document).ready(c),v.on("click",".initiate-pay",d),v.on("click",".pay-vip",u),v.on("click",".coupon-submit",n),v.on("hide.bs.modal","#"+b,function(){h.order_num=!1,y=!1}),f=a("#"+b).modal({backdrop:"static",show:!1,keyboard:!1}),f.on("countdown-over",".pay-over-time>*",t)}function t(){var e="订单支付超时，请重新下单";f.find(".pay-qrcode img").css("filter","blur(4px)"),r(e,"danger"),notyf(e,"danger"),f.on("click",function(e){a(e.target).is(a(this))&&f.modal("hide")}),h.order_num=!1}function i(a){var e=a.find(".actual-price-number");if(e.length){var t=parseFloat(e.data("price"));e.text(t)}a.find(".coupon-data-box").html(""),a.find('input[name="coupon"]').val("")}function n(){var e=a(this),t=e.parents(".coupon-input-box").find('input[name="coupon"]'),i=e.parents("form"),n=i.serializeObject(),o=e.parents(".coupon-input-box").find(".coupon-data-box");if(n.action="coupon_submit",!n.coupon)return notyf("请输入优惠码","warning"),!1;var s=i.find(".actual-price-number"),d=0;return s.length&&(d=parseFloat(s.data("price")),s.text(d)),o.html(""),zib_ajax(e,n,function(a){a.error&&t.val("");var e="";"subtract"==a.discount.type?(e='<span class="muted-2-color">优惠立减</span><span class="font-bold c-red em14">-'+a.discount.val+"</span>",d&&(d=(d-a.discount.val).toFixed(2))):"multiply"==a.discount.type&&(d?(e='<span class="c-red">'+10*a.discount.val+'折优惠</span><span class="font-bold c-red em14">-'+parseFloat((d*(1-a.discount.val)).toFixed(2))+"</span>",d=(d*a.discount.val).toFixed(2)):e='<span class="muted-2-color">优惠</span><span class="font-bold c-red em14">'+10*a.discount.val+"折</span>"),e=e?'<div class="discount-box flex jsb ab">'+e+"</div>":"",a.expire_time&&(e+='<div class="coupon-time flex jsb ab"><span class="muted-2-color">有效期至</span><span class="muted-color">'+a.expire_time+"</span></div>");var i='<div class="mt10 coupon-box mb10 muted-box padding-h6 line-16"><div><span class="badg badg-sm mr6 jb-blue">优惠码可用</span>'+(a.title?"<span>"+a.title+"</span>":"")+"</div>"+e+"</div>";o.html(i),s.length&&(d=d<0?0:parseFloat(d),s.text(d))},"stop"),!1}function o(e,t){e.openid&&notyf("正在发起支付，请稍后...","load","","pay_ajax"),zib_ajax(t,e,function(n){if(n.error_code&&"coupon_error"==n.error_code&&i(t.parents("form")),n.error){if(n.modal&&(refresh_modal({class:"modal-mini full-sm",height:330,mobile_from_bottom:!0,touch_close:!0,content:n.modal}),a(".shop-confirm-modal.in,#modal_pay_uservip.in").modal("hide")),n.float_btn){var o=a(".float-right-wait-pay");o.length?o.prop("outerHTML",n.float_btn):v.append(n.float_btn)}}else{if(n.url&&n.open_url)return window.location.href=n.url,window.location.reload,void notyf("正在跳转到支付页面");if(n.form_html)return v.append(n.form_html),void notyf("正在跳转到支付页面");if(n.jsapiParams){var d=n.jsapiParams,c=n.jsapi_return||0;return"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",l(d,c),!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",l(d,c)),document.attachEvent("onWeixinJSBridgeReady",l(d,c))):l(d,c),void notyf("请完成支付","","",e.openid?"pay_ajax":"")}n.url_qrcode&&(f.find(".more-html").remove(),a(".modal:not(#"+b+")").modal("hide"),f.find(".pay-qrcode img").attr("src",n.url_qrcode),r("请扫码支付，支付成功后会自动跳转",""),n.more_html&&f.find(".pay-notice").before('<div class="more-html">'+n.more_html+"</div>"),n.order_name&&f.find(".pay-title").html(n.order_name),n.order_price&&f.find(".pay-price").html(n.order_price),n.payment_method&&f.find(".pay-payment").removeClass("wechat alipay").addClass(n.payment_method),n.over_time&&f.find(".pay-over-time").html('<span class="ml6 badg badg-sm" int-second="1" data-over-text="交易已关闭" data-countdown="'+n.over_time+'"></span>'),f.modal("show"),h=n,y||(s(),y=!0))}},"stop")}function s(){h.order_num&&a.ajax({type:"POST",url:g,data:{action:"check_pay",order_num:h.order_num,check_sdk:h.check_sdk},dataType:"json",success:function(a){"1"==a.status?(r("支付成功，页面跳转中","success"),setTimeout(function(){void 0!==_.return_url&&_.return_url?(window.location.href=delQueStr("openid",delQueStr("zippay",_.return_url)),window.location.reload):(location.href=delQueStr("openid",delQueStr("zippay")),location.reload)},300)):"-1"==a.status?t():setTimeout(function(){s()},2e3)}})}function d(){var e=a(this),t=e.parents("form");return _=t.serializeObject(),_.action||(_.action="initiate_pay"),_.return_url||(_.return_url=window.location.href),o(_,e),!1}function r(a,e){var t=f.find(".pay-notice .notice");a="load"==e?'<i class="loading mr6"></i>'+a:a,t.removeClass("load warning success danger").addClass(e).html(a)}function l(a,e){WeixinJSBridge.invoke("getBrandWCPayRequest",a,function(a){var t=delQueStr("openid",delQueStr("zippay"));if("get_brand_wcpay_request:ok"==a.err_msg&&e)return location.href=e,void location.reload;location.href=t,location.reload})}function c(){var e=GetRequest("zippay"),t=GetRequest("openid");e&&t&&p()&&(_.pay_type="wechat",_.openid=t,_.action="initiate_pay",o(_,a("<div></div>")))}function p(){var a=window.navigator.userAgent.toLowerCase();return"micromessenger"==a.match(/MicroMessenger/i)}function u(){var e=a(this),t='<div class="modal fade flex jc" id="modal_pay_uservip" tabindex="-1" role="dialog" aria-hidden="false">    <div class="modal-dialog" role="document">    <div class="modal-content">    <div class="modal-body"><h4 style="padding:20px;" class="text-center"><i class="loading zts em2x"></i></h4></div>    </div>    </div>    </div>    </div>';a("#modal_pay_uservip").length||v.append(t);var i=a("#modal_pay_uservip"),n=e.attr("vip-level")||1;return i.find(".payvip-modal").length?(a('a[href="#tab-payvip-'+n+'"]').tab("show"),i.modal("show")):(notyf("加载中，请稍等...","load","","payvip_ajax"),a.ajax({type:"POST",url:g,data:{action:"pay_vip",vip_level:n},dataType:"json",success:function(e){var t=e.msg||"请选择会员选项";-1!=t.indexOf("登录")&&(i.remove(),a(".signin-loader:first").click()),notyf(t,e.ys?e.ys:e.error?"danger":"",3,"payvip_ajax"),e.error||(i.find(".modal-content").html(e.html),i.find(".modal-content .tab-pane.active").length||i.find('.modal-content a[data-toggle="tab"]:eq(0)').click(),i.trigger("loaded.bs.modal").modal("show"),auto_fun())}})),!1}var m=window._win,v=a("body"),f=!1,y=!1,h={},_={},g=m.ajax_url,b="zibpay_modal";e();var x='[data-controller="payment_method"][data-value="card_pass"]';v.on("controller.change",x,function(e,t){var i=a(this),n=i.parents("form");t?n.find(".charge-box").hide():n.find(".charge-box").show()}),v.on("loaded.bs.modal","#refresh_modal",function(){a(this).find(x).length&&a(this).find('input[name="payment_method"]').trigger("change")})})(jQuery);