(function(){function a(a){var t=$(".vote-options");a.length&&t.length&&("pk"==a.val()?(t.children().eq(1).nextAll().remove(),t.data("max",2).cloneable()):t.data("max",10).cloneable())}var t=$("body");t.on("click",".bbs-posts-submit",function(){var a=$(this),t=a.attr("action"),e=a.parents("form"),i=e.serializeObject();i.action=t,tinyMCE&&(i.post_content=tinyMCE.activeEditor.getContent());var n=$(".featured-edit");if(n.length){var s=n.data("featured_data");i.featured_data=!!s&&s.data}zib_ajax(a,i,function(a){a.html&&e.find(".submit-text").html(a.html),a.post_id&&e.find('input[name="post_id"]').val(a.post_id)})}),t.on("change","[name='vote[type]']",function(){a($(this))}),$(document).ready(function(){setTimeout(function(){a($("[name='vote[type]']"))},100)}),$.fn.vote=function(){function a(a,t=0){var e=a.data(n+"-all")+t,i=a.data("type");a.find(p).each(function(){var a=$(this),t=a.data(n);a.children("."+m).length||a.prepend('<div class="'+m+'"></div>');var s=(t/e*100).toFixed(4);"px"!=i||e||(s="50%"),setTimeout(function(){a.children("."+m).css("width",s+"%")},200),a.children("."+u).html(~~s+"%"),a.children("."+v).html(t+"票")})}function t(t,i){i.action=f,t.hasClass(l)||(t.addClass(l),$.post(e,i,function(e){if(e.data){t.off(d).removeClass(l+" "+o).addClass(r),a(t,i.voted.length);var n=t.find("."+c);n.length&&n.text(1+~~n.text()),t.find("."+s).html("投票成功"),t.find(h).hide()}else t.removeClass(l)},"json"))}var e=_win.ajax_url,i="vote",n=i+"d",s=i+"-start",d="click",o=i+"-allow",l=i+"-loading",c=i+"-user-count",r=i+"-ok",m=i+"-progress",u=i+"-percentage",v=i+"-number",f="submit_"+i,p="."+i+"-item",h="."+i+"-submit",_="is-"+n,g="is-on";return this.each(function(){var e=$(this),i=e.data("type"),s=e.data("post-id"),c={id:s};if(a(e),e.hasClass(o)&&!e.data(g))if("multiple"===i){var r=e.find(h);e.data(g,!0).on(d,p,function(){var a=$(this),t=a.data(n);a.hasClass(_)?a.removeClass(_).data(n,t-1):a.addClass(_).data(n,t+1),e.find(p+"."+_).length?r.show():r.hide()}).on(d,h,function(){if(!e.hasClass(l)){var a=[];e.find(p).each(function(t){$(this).hasClass(_)&&a.push(t)}),c.voted=a,t(e,c)}})}else e.data(g,!0).on(d,p,function(){if(!e.hasClass(l)){var a=$(this).addClass(_),i=a.data(n);a.data(n,i+1);var s=a.data("index");c.voted=[s],t(e,c)}})})},document.addEventListener("lazybeforeunveil",function(a){var t=$(a.target);t.hasClass("vote-box")&&setTimeout(function(){t.vote()},500)}),t.on("miniuploaded","[term-taxonomy]",function(a,t){if(t.term_id){if("add"===t.type){var e,i;switch(t.taxonomy){case"plate_cat":e=$(".plate-cat-radio"),e.length&&(e.find(".container-null").remove(),i=$('<label><input type="radio" name="cat" value="'+t.term_id+'"><span class="p2-10 mr6 but but-radio">'+t.term.name+"</span></label>"));break;case"forum_tag":e=$("#tag_select_tab_main"),e.length&&(i=$('<span data-multiple="5" data-for="tag" data-value="'+t.term_id+'" class="tag-list ajax-item pointer"><span class="badg mm3">'+t.term.name+"</span></span>"),$('[href="#tag_select_tab_main"]').click());break;case"forum_topic":e=$("#topic_select_tab_main"),e.length&&(i=$('<div data-for="topic" data-value="'+t.term_id+'" class="flex padding-10 topic-list ajax-item pointer"><div class="square-box mr10 thumb">'+(t.image_url?'<img src="'+t.image_url+'" class="fit-cover radius4">':"")+'</div><div class="info"><div class="name"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-topic"></use></svg>'+t.term.name+'<svg class="icon" aria-hidden="true"><use xlink:href="#icon-topic"></use></svg></div><div class="muted-3-color em09 desc"><span class="mr20">帖子:0</span><span class="">2秒前创建</span></div></div></div>'),$('[href="#topic_select_tab_main"]').click())}return e.prepend(i),i.click()}window.location.href=t.term_url,window.location.reload}}),t.on("miniuploaded","[plate-save]",function(a,t){if(t.id){if("add"===t.type){var e=$("#plate_select_tab_main");if(e.length){var i=$('<div data-for="plate" data-value="'+t.id+'" class="flex padding-10 plate-list ajax-item pointer"><div class="square-box mr10 thumb">'+(t.image_url?'<img src="'+t.image_url+'" class="radius-cover">':"")+'</div><div class="info"><div class="name">'+t.post.post_title+'</div><div class="muted-3-color em09 desc mt3">3秒前创建</div></div></div>');return e.prepend(i),$('[href="#plate_select_tab_main"]').click(),i.click()}}window.location.href=t.url,window.location.reload}}),t.on("zib_ajax.success",".answer-adopt-submit",function(a,t){t&&t.comment_id&&t.badeg&&$(".answer-adopt-id-"+t.comment_id).prop("outerHTML",t.badeg)})})();